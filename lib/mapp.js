var $o=Object.defineProperty;var S=(e,t)=>{for(var o in t)$o(e,o,{get:t[o],enumerable:!0})};var He={cancel:"Cancel",circle_config:"Circle configuration",confirm:"Confirm",confirm_delete:"Are you sure you want to delete this feature? This cannot be undone.",create:"Create",csv_upload_failed:"Data import failed, please try again.",csv_upload_import:"Import From CSV",csv_upload_number_of_columns_imported:"The number of columns in your imported file",csv_upload_number_of_columns_required:"is not the same as the number of columns required",csv_upload_rows_imported:"Rows Imported",csv_upload_success:"Data imported successfully",dark_mode:"Colour Mode",delete:"Delete",delete_geometry:"Delete Geometry",delete_vertex:"Remove vertex",document_upload_failed:"Document upload failed.",drag_and_drop_doc:"Drag and drop or add document",drag_and_drop_image:"Drag and drop or add image",draw_circle:"Circle from Centre",draw_circle_2pt:"Manual Circle",draw_dialog_begin_drawing:"Begin Drawing - Click anywhere on the map",draw_dialog_cancel_drawing:"Cancel Drawing - ESC Key",draw_dialog_remove_vertex:"Remove Last Vertex - Right Click",draw_dialog_save:"Save - Double Click",draw_dialog_save_single:"Save - Single Click",draw_dialog_title:"Drawing Instructions",draw_line:"Line",draw_point:"Point",draw_polygon:"Polygon",draw_position:"Current Position",draw_rectangle:"Rectangle",edit_dialog_cancel_drawing:"Cancel Drawing - Click on the cancel button to cancel the drawing.",edit_dialog_modify_shape:"Edit Shape- Drag a vertex to modify the shape, or add a new vertex on the polygon.",edit_dialog_remove_vertex:"Remove Vertex - Click on a vertex to remove it.",edit_dialog_save:"Save - Click on the save button to save your changes.",edit_dialog_title:"Editing Instructions",feature_info:"Feature Info",filter_searchbox_placeholder:"Search",icon_scaling_cluster:"Cluster Icon Scale",icon_scaling_cluster_log:"Cluster Log Scale",icon_scaling_field:"Toggle Field Icon Scaling",icon_scaling_label:"Icon Scale",icon_scaling_no_scaling:"No Scaling",icon_scaling_select_one:"Select a field",icon_scaling_title:"Icon Scaling",icon_scaling_zoom_in:"Zoom-in Scale",icon_scaling_zoom_out:"Zoom-out Scale",identical_values_filter:"This field contains only one distinct value and cannot be filtered on.",image_upload_failed:"Image upload failed.",information:"Information",invalid_geometry:"Invalid geometry",invalid_lat_lon:"The provided Coordinates do not fall within the selected Locale.",invalid_lat_long_range:"Invalid coordinates: Latitude and longitude values must be within valid ranges.",invalid_entry_value:"Unable to update location with invalid entry value.",layer_add_new_location:"Add new locations",layer_dataview_header:"Data Views",filter_clear_all:"Clear all filters",layer_filter_dropdown_select:"Select Multiple",layer_filter_greater_than:"Greater than",filter_header:"Filter",layer_filter_less_than:"Less than",filter_reset_all:"Reset all filters",filter_select:"Select filter from list",layer_filter_set_filter:"Set filter",layer_grid_legend_ratio:"Display colour as a ratio to the size",layer_group_hide_layers:"Hide all layers in group",layer_style_cluster:"Multiple locations",layer_style_display_hover:"Enable hover",layer_style_display_labels:"Display labels",layer_style_header:"Style",layer_style_opacity:"Change layer opacity:",layer_style_select_label:"Select field to use as label",layer_style_select_theme:"Select thematic style",layer_style_switch_all:"switch all",layer_style_switch_caption:"Click on labels to switch visibility or",layer_visibility:"Toggle visibility",layer_zoom_to_extent:"Zoom to filtered layer extent",layers:"Layers",link:"Link",loading:"Loading",location_clear_all:"Clear locations",location_new_failed:"Creating new location has failed.",location_no_location_selected:"No Locations selected",location_close_without_save:"Close location without saving changes?",location_delete:"Delete location",location_listview_full:"The listview for locations is full.",location_remove:"Remove feature from selection",location_save:"Save changes to cloud",location_save_changes:"Save your changes to this location?",location_zoom:"Zoom map to feature bounds",location_update_failed:"Location update has failed.",locations:"Locations",login_email:"E-mail",login_password:"Password",login_button:"Log In",login_invalid:"Invalid email or password does not meet the requirement of minimum 12 characters.",login_verification_note:"Your account must be verified by following a verification link sent to the email address and approved by an administrator before you are able to log in.",login_registration_link:"Register a new account or reset your password.",modify_geometry:"Modify Geometry",filter_btn_label:"Filters",filter_btn_title:"Open Filtering View",filter_count:"Location(s) match filter criteria",filter_dialog_title:"Filter Panel",filter_in_viewport:"viewport based.",filter_not_in_viewport:"all locations not just those in viewport.",gazetteer:"Search for a location",no_data_filter:"This field contains no data and cannot be filtered on.",no_layers:"No accessible layers in locale.",no_locales:"Your account has been verified and approved, but you do not have access to any locales. This is likely as an administrator has not given you the required roles. Please contact an administrator to resolve this.",no_options_available:"No options available.",no_results:"No results for this search",ok:"OK",pill_component_remove:"Remove",pin:"Pin",query_failed:"Query failed.",radius:"Radius",register_agree:"I agree",register_email:"E-mail",register_error:"Please make sure credentials meet the security requirements.",register_login:"Already registered? Login.",register_new_password:"New Password (min. length 12, must contain a digit, upper, and lower case character)",register_next:"What happens next? Confirming your account",register_next_info:"XYZ/MAPP will attempt to deliver an email to your email address. You must click on the link in the email to verify that you are the account holder. Please check your spam folder if you can not find this email. You will need to contact a site administrator if you are unable to access the verification link. Newly registered accounts must be approved by a site administrator once verified.",register_privacy:"Privacy Agreement",register_privacy_agreement:"User account data may be stored in a third party database. Passwords are encrypted at rest. Administrator will never ask for your password. User account data will not be shared with a third party. Administrator may disable, block, or remove your account. Please refer to the XYZ/MAPP documentation to remove your stored account details. You must agree to these conditions in order to register your account.",register_reset:"Register or Reset Password",register_retype_password:"Re-type password",register_title:"Registration",remove_document_confirm:"Are you sure to remove this document? This cannot be undone.",remove_image_confirm:"Are you sure to remove the image? This cannot be undone.",remove_item_confirm:"Remove item?",remove_last_vertex:"Remove last vertex",report:"Report",save:"Save",toolbar_admin:"Open account admin view",toolbar_current_location:"Current location",toolbar_fullscreen:"Fullscreen mapview",toolbar_login:"Log in",toolbar_logout:"Log out",toolbar_zoom_in:"Zoom in",toolbar_zoom_out:"Zoom out",toolbar_zoom_to_area:"Zoom to area",units:"Units",user_locale_desc:"Below is a list of your current saved locales:",user_locale_specific:"Your locales are specific to you.",user_locale_context:"Each project includes where your map is positioned, the layers that you see on the map and how they are styled. ",user_locale_save:"Name your project, and click the save button.",zoom_to:"Zoom to Extent"};var We=new Proxy({},{get:Lo});function Lo(e,t,o){return Object.hasOwn(mapp.dictionaries,mapp.language)||(console.warn(`'${mapp.language}' mapp.language is not supported by mapp.dictionaries.`),mapp.language="en"),Object.hasOwn(mapp.dictionaries[mapp.language],t)?mapp.dictionaries[mapp.language][t]:Object.hasOwn(mapp.dictionaries.en,t)?mapp.dictionaries.en[t]:t}var Ye={en:He};var g={current:{layers:[],locations:[]},filter:Fo,parse:Io,push:To,remove:Xe,removeAll:Po,set:Oo},M=g;function Io(){let e=new URL(window.location.href);for(let[t,o]of e.searchParams.entries()){if(o==="false"){g.current[t]=!1;continue}if(o==="true"){g.current[t]=!0;continue}if(t==="locations"||t==="layers"){g.current[t]=decodeURIComponent(o).split(",");continue}g.current[t]=o.includes(",")?decodeURIComponent(o).split(","):o}g.current.token&&(e.searchParams.delete("token"),window.history.replaceState({},document.title,e.toString()),delete g.current.token)}function Oo(e){Object.assign(g.current,e),O()}function Xe(e){Array.isArray(g.current[e])?g.current[e].length=0:delete g.current[e],O()}function Po(){Object.keys(g.current).forEach(e=>Xe(e)),O()}function To(e,t){g.current[e]?g.current[e].indexOf(t)<0&&g.current[e].push(t):g.current[e]=[t],O()}function Fo(e,t){Array.isArray(g.current[e])&&(g.current[e]=g.current[e].filter(o=>o!==t),O())}function O(){try{window.history.pushState({},document.title,`?${mapp.utils.paramString(g.current)}`)}catch(e){console.log(e)}}async function G(e){if(mapp.utils.keyvalue_dictionary(e),!Object.hasOwn(mapp.layer.formats,e.format)){console.warn(`Layer: ${e.key}; ${e.format} format unavailable.`);return}if(await mapp.layer.formats[e.format](e),!!e.L)return Object.assign(e,{changeEnd:Vo,geomCurrent:No,getExtent:Ao,hide:zo,hideCallbacks:[],remove:Ro,removeCallbacks:[],show:Mo,showCallbacks:[],tableCurrent:Do,update:Bo,zoomToExtent:qo}),e.name??=e.key,e.changeEndCallbacks??=[],e.draw?.delete&&console.warn(`Layer: ${e.key}, please move draw.delete to use layer.deleteLocation:true.`),e.filter={current:{},...e.filter},Array.isArray(e.featureSet)&&(e.featureSet=new Set(e.featureSet)),e.L.setOpacity(e.style?.opacity||1),Array.isArray(e.infoj_skip)&&e.infoj.filter(t=>[t.key,t.field,t.query,t.type,t.group].some(o=>e.infoj_skip.includes(o))).forEach(t=>t.skipEntry=!0),e.featureLocation&&e?.infoj?.forEach(t=>delete t.edit),Object.keys(e).forEach(t=>{typeof mapp.layer[t]=="function"&&mapp.layer[t]?.(e),typeof mapp.plugins[t]=="function"&&mapp.plugins[t]?.(e)}),e}async function Ao(){let e=this,t=[];if(Array.isArray(e.featureLookup))t=e.featureLookup.map(r=>r[e.featureLookupId||"id"]);else if(Array.isArray(e.featureSet)||e.featureSet instanceof Set)t=[...e.featureSet];else if(e.L&&e.format!=="mvt")return e.L.getSource().getExtent();let o=t.length?JSON.stringify({ids:t}):void 0;return await mapp.utils.xhr({url:`${e.mapview.host}/api/query/layer_extent?`+mapp.utils.paramString({filter:e.filter?.current,geom:e.geomCurrent(),layer:e.source_key||e.key,locale:e.mapview.locale.key,proj:e.srid,srid:e.mapview.srid,table:e.table||Object.values(e.tables)[0]||Object.values(e.tables)[1]}),body:o})}function Mo(){this.mapview.hooks&&mapp.hooks.push("layers",this.key),this.display=!0;try{this.mapview.Map.addLayer(this.L)}catch{}this.reload instanceof Function&&this.reload(),this.mapview.attribution?.check(),this.showCallbacks?.forEach(e=>e instanceof Function&&e(this))}function zo(){this.display=!1,this.mapview.Map.removeLayer(this.L),this.mapview.attribution?.check(),this.mapview.hooks&&!this.zoomDisplay&&mapp.hooks.filter("layers",this.key),this.hideCallbacks?.forEach(e=>e instanceof Function&&e(this))}function Do(){if(this.table)return this.table;let e;if(!this.tables)return!1;let t=parseInt(this.mapview.Map.getView().getZoom()),o=Object.keys(this.tables),n=parseInt(o[0]),r=parseInt(o[o.length-1]);return e=this.tables[t],e=t<n?this.tables[n]:e,e=t>r?this.tables[r]:e,e}function No(){if(!this.geoms)return this.geom;let e,t=parseInt(this.mapview.Map.getView().getZoom()),o=Object.keys(this.geoms),n=parseInt(o[0]),r=parseInt(o[o.length-1]);return e=this.geoms[t],e=t<n?this.geoms[n]:e,e=t>r?this.geoms[r]:e,e}async function qo(e){let t=this,o=await t.getExtent();return!o||Array.isArray(o)&&o.length===0?!1:(t.mapview.fitView(o,e),!0)}function Vo(){this.tables&&(this.tableCurrent()?this.zoomDisplay&&(delete this.zoomDisplay,this.show()):this.display&&(this.zoomDisplay=!0,this.hide())),this.display&&!this.zoomDisplay&&this.params?.viewport&&this.reload();for(let e of this.changeEndCallbacks)typeof e=="function"&&e(this)}async function Bo(e){let t=this;e.mapview=t.mapview;let o=await mapp.layer.decorate(e);if(!o.L){console.warn("Updated layer could not be decorated");return}let n=document.getElementById("layers");return n&&(mapp.ui.layers.view(o),n?.insertBefore(o.view,t.view)),t.remove(),o.mapview.layers[t.key]=o,o.display&&o.show(),o}function Ro(){let e=this;e.view?.remove(),e.hide(),e.L?.dispose(),e.removeCallbacks.forEach(t=>typeof t=="function"&&t(this)),delete e.mapview.layers[e.key]}function z(e,t){if(!e?.fade)return;clearTimeout(e.fade);let o=e.L.getOpacity(),n;if(t){if(o<=0)return;n=Math.max(o-.2,0)}else{if(o>=1)return;n=Math.min(o+.2,1)}let r=100,i=Date.now(),a=()=>{let l=Date.now()-i;if(l<r){let c=l/r,u=o+(n-o)*c;e.L.setOpacity(u),requestAnimationFrame(a)}else e.L.setOpacity(n)};a(),e.fade=setTimeout(()=>z(e,t),r)}var K={};S(K,{distribution:()=>Z,fieldsArray:()=>Jo,process:()=>Go,reset:()=>Uo});function Uo(e){e.params.fields&&(e.featureFields??={},e.params.fields.forEach(t=>{e.featureFields[t]={values:[]}}))}async function Go(e){if(e.style.icon_scaling?.field){let t=e.featureFields[e.style.icon_scaling?.field].values.map(Number).filter(o=>!isNaN(o));e.style.icon_scaling.max=Math.max(...t)}Object.hasOwn(Z,e.style?.theme?.distribution)&&(await Z[e.style.theme.distribution](e),e.L.changed(),mapp.ui.layers.legends[e.style.theme.type](e))}var Z={count:Ko,jenks:Zo};async function Zo(e){let t=e.style.theme,o=Math.min(e.featureFields[t.field].values.length,t.categories.length);e.featureFields[t.field].values=e.featureFields[t.field].values.filter(i=>i!==null).map(Number.parseFloat);let n=await mapp.utils.simpleStatistics();e.featureFields[t.field].jenks=n.jenks(e.featureFields[t.field].values,o);let r;t.categories.forEach((i,a)=>{r=r===e.featureFields[t.field].jenks[a]?void 0:e.featureFields[t.field].jenks[a],i.value=r,i.label=mapp.utils.formatNumericValue({...t.legend,value:r})})}function Ko(e){let t=e.style.theme;Array.isArray(t.fields)?t.fields.forEach(o=>{e.featureFields[o].values.forEach(n=>{e.featureFields[o][n]??=0,e.featureFields[o][n]++})}):t.field&&e.featureFields[t.field].values.forEach(o=>{e.featureFields[t.field][o]??=0,e.featureFields[t.field][o]++})}function Jo(e){let t=new Set([e.params.default_fields,e.style.theme?.field,e.style.label?.field,e.style.icon_scaling?.field,e.cluster?.label]);return Array.isArray(e.style.theme?.fields)&&e.style.theme.fields.forEach(t.add,t),Array.from(t).flat().filter(o=>!!o)}var J={};S(J,{cluster:()=>Ho,geojson:()=>Wo,wkt:()=>Yo,wkt_properties:()=>Xo,wkth3:()=>Qo});function Ho(e,t){return e.cluster.max_size=1,t.map((o,n)=>{let r=new ol.geom.Point(o.shift()),i=o.shift();e.cluster.max_size=e.cluster.max_size>i?e.cluster.max_size:i;let a=o.shift(),s={count:i};return e.params.fields.forEach((l,c)=>{s[l]=o[c]}),new ol.Feature({geometry:r,id:a,...s})})}function Wo(e,t){let o=new ol.format.GeoJSON;return mapp.layer.featureFields.reset(e),t.map(n=>(e.params.fields?.forEach(r=>{e.featureFields[r].values.push(n.properties[r])}),new ol.Feature({geometry:o.readGeometry(n.geometry,{dataProjection:"EPSG:"+e.srid,featureProjection:"EPSG:"+e.mapview.srid}),id:n.id,...n.properties})))}function Yo(e,t){if(!Array.isArray(t))return;let o=new ol.format.WKT;mapp.layer.featureFields.reset(e);let n=t.map(r=>{let i={};Array.from(new Set(["id","wkt_geometry",...e.params.fields]))?.forEach((l,c)=>{e.featureFields[l]?.values?.push(r[c]),i[l]=r[c]});let s=o.readGeometry(i.wkt_geometry,{dataProjection:"EPSG:"+e.srid,featureProjection:"EPSG:"+e.mapview.srid});return new ol.Feature({geometry:s,...i})});return mapp.layer.featureFields.process(e),n}function Xo(e,t){mapp.layer.featureFields.reset(e);for(let o of t){let n={id:o[0]};e.params.fields?.forEach((r,i)=>{e.featureFields[r].values.push(o[i+1]),n[r]=o[i+1]}),e.featuresObject[o.shift()]=n}mapp.layer.featureFields.process(e)}var Qe=new Map;async function Qo(e,t){let o=await mapp.utils.esmImport("h3-js@4.4.0");if(!Array.isArray(t))return;mapp.layer.featureFields.reset(e);let n=t.map(r=>{let i={},a=Array.from(new Set(["id",...e.params.fields]));for(let[l,c]of Object.values(a).entries())e.featureFields[c]?.values?.push(r[l]),i[c]=r[l];let s=Qe.get(i.id);if(!s){let l=o.cellToBoundary(i.id).map(c=>c.reverse());l.push(l[0]),s=new ol.geom.Polygon([l]).transform("EPSG:4326","EPSG:3857"),Qe.set(i.id,s)}return new ol.Feature({geometry:s,...i})});return mapp.layer.featureFields.process(e),n}function H(e,t){if(!t.style.hover.display)return;let o=t.mapview.interaction?.current?.key?.toString();if(!o)return;let n=t.tableCurrent();if(!n)return;let r=mapp.utils.paramString({coords:e.properties.count>1&&ol.proj.transform(e.getGeometry().getCoordinates(),`EPSG:${t.mapview.srid}`,`EPSG:${t.srid}`),field:t.style.hover.field,filter:e.properties.count>1&&t.filter?.current,geom:t.geom,id:e.properties.id,layer:t.key,layer_template:t.params?.layer_template,locale:t.mapview.locale.key,qID:t.qID,table:n,template:t.style.hover.query||"infotip"});mapp.utils.xhr({url:`${t.mapview.host}/api/query?${r}`,cache:!0,debounce:{key:"hover",delay:100}}).then(i=>{if(i){if(typeof t.style.hover.render=="function"){let a=t.style.hover.render(i);t.mapview.infotip(a);return}i.label!=""&&t.mapview.interaction?.current?.key===o&&t.mapview.infotip(i.label)}}).catch(i=>{})}function D(e){return function(l){if(e.style.cache===!0){let c=l.get("Styles");if(c)return c}if(t(l),l.properties===null)return null;if(l.style=e.style.default,Object.hasOwn(mapp.layer.themes,e.style.theme?.type)&&mapp.layer.themes[e.style.theme?.type]?.(e.style.theme,l),l.style!==null)return o(l),n(l),r(l),i(l),a(l),mapp.utils.style(l.style,l)};function t(s){if(s.properties=s.getProperties(),e.featureSet?.size&&!e.featureSet.has(s.properties.id)){s.properties=null;return}if(e.featuresObject)if(Object.hasOwn(e.featuresObject,s.properties.id))Object.assign(s.properties,e.featuresObject[s.properties.id]);else{s.properties=null;return}if(Array.isArray(e.featureLookup)){let l=e.featureLookup.find(c=>c[e.featureLookupId||"id"]===s.properties.id);if(!l){s.properties=null;return}Object.assign(s.properties,l)}s.properties?.properties&&(console.warn("Feature with properties.properties"),Object.assign(s.properties,s.properties.properties),delete s.properties.properties)}function o(s){if(!s.properties?.count||s.properties.count===1||!e.style.cluster)return;let l=parseFloat(e.style.cluster.clusterScale);s.style={...s.style,...e.style.cluster},l&&(s.style.clusterScale=e.style.cluster.logScale?Math.log(l)/Math.log(e.cluster?.max_size)*Math.log(s.properties.size||s.properties.count):1+l/e.cluster?.max_size*(s.properties.size||s.properties.count)),e.style.cluster.zoomInScale&&(s.style.zoomInScale=e.style.cluster.zoomInScale*e.mapview.Map.getView().getZoom()),e.style.cluster.zoomOutScale&&(s.style.zoomOutScale=e.style.cluster.zoomOutScale/e.mapview.Map.getView().getZoom())}function n(s){e.style.highlight&&e.highlight&&e.highlight===(s.get("id")||s.getId())&&(s.style={...s.style,...e.style.highlight})}function r(s){if(s.properties&&s.style){if(!e.style.label?.display){delete s.style.label;return}s.style.label=structuredClone(e.style.label),s.style.label.text=s.style.label.count&&s.properties.count>1&&s.properties.count||void 0,s.style.label.text??=s.properties[s.style.label.field]||s.properties.label,s.style.label?.minZoom>e.mapview.Map.getView().getZoom()&&delete s.style.label,s.style.label?.maxZoom<e.mapview.Map.getView().getZoom()&&delete s.style.label}}function i(s){e.style.selected!==void 0&&e.mapview?.locations[`${e.key}!${s.properties.id}`]&&(s.style=e.style.selected)}function a(s){if(!e.style.icon_scaling?.field)return;let l=Number(s.properties[e.style.icon_scaling.field]);if(s.properties.features?.length>1){if(!e.style.icon_scaling.cluster)return;l=0,s.properties.features.forEach(u=>{l+=Number(u.getProperties()[e.style.icon_scaling.field])}),e.style.icon_scaling.cluster==="avg"&&(l/=s.properties.features.length)}if(isNaN(l))return;l<0&&(l=0);let c=e.style.icon_scaling.scaleFactor||e.style.icon_scaling.max||1;s.style.fieldScale=1+l/c}}async function W(e){e.style??={},e.style.mapType??="roadmap",e.L=new ol.layer.WebGLTile({className:`mapp-layer-${e.key}`,key:e.key,source:new ol.source.Google({highDpi:!0,key:e.apiKey,layerTypes:e.style.layerTypes,mapType:e.style.mapType,scale:"scaleFactor2x"}),zIndex:e.zIndex})}async function Y(e){await mapp.utils.scriptElement("https://cdn.jsdelivr.net/npm/ol-mapbox-style@13.0.1/dist/olms.js"),e.L=new ol.layer.VectorTile({declutter:!0,zIndex:e.zIndex}),olms.applyStyle(e.L,e.style.URL,{accessToken:e.accessToken})}var N;async function X(e){N||(N=await mapp.utils.esmImport("maplibre-gl@5.5.0"),N.setRTLTextPlugin("https://cdn.jsdelivr.net/npm/@mapbox/mapbox-gl-rtl-text@0.3.0/dist/mapbox-gl-rtl-text.min.js",!0));let t=`mapp-layer-${e.key} maplibre`;if(e.container=mapp.utils.html.node`<div
    class=${t}
    style="visibility: hidden; position: absolute; width: 100%; height: 100%;">`,e.mapview.Map.getTargetElement().prepend(e.container),e.style?.URL&&e.accessToken){let n=tt(e.style.URL,e.accessToken);if(e.style.object=await mapp.utils.xhr(n),e.style.object instanceof Error)return}if(!e.style?.object){console.warn(`${e.key} failed to load, check that an access token and a style.URL are provided.`);return}let o=new N.Map({attributionControl:!1,boxZoom:!1,container:e.container,doubleClickZoom:!1,dragPan:!1,dragRotate:!1,interactive:!1,keyboard:!1,pitchWithRotate:!1,pixelRatio:1,canvasContextAttributes:{preserveDrawingBuffer:e.preserveDrawingBuffer},scrollZoom:!1,style:e.style?.object,touchZoomRotate:!1,transformRequest:(n,r)=>n.indexOf("mapbox:")===0?en(n,r,e.accessToken):{url:n}});Map&&(e.mapview.Map.getTargetElement().addEventListener("resize",()=>o.resize()),e.style.zIndex&&console.warn(`Layer: ${e.key}, layer.style.zIndex has been deprecated. Use layer.zIndex instead.`),e.L=new ol.layer.Layer({key:e.key,render:n=>{if(e.display)return e.container.style.visibility="visible",o.jumpTo({animate:!1,bearing:-n.viewState.rotation*180/Math.PI,center:ol.proj.toLonLat(n.viewState.center),zoom:n.viewState.zoom-1}),e.container},zIndex:e.zIndex}))}function en(e,t,o){if(e.indexOf("/styles/")>-1&&e.indexOf("/sprite")===-1)return{url:tt(e,o)};if(e.indexOf("/sprites/")>-1)return{url:on(e,o)};if(e.indexOf("/fonts/")>-1)return{url:tn(e,o)};if(e.indexOf("/v4/")>-1)return{url:et(e,o)};if(t==="Source")return{url:et(e,o)}}function P(e){let t=e.match(/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/);if(!t)throw new Error("Unable to parse URL object");return{authority:t[2],params:t[4]?t[4].split("&"):[],path:t[3]||"/",protocol:t[1]}}function q(e,t){let o=P("https://api.mapbox.com");e.protocol=o.protocol,e.authority=o.authority,e.params.push(`access_token=${t}`);let n=e.params.length?`?${e.params.join("&")}`:"";return`${e.protocol}://${e.authority}${e.path}${n}`}function tt(e,t){let o=P(e);return o.path=`/styles/v1${o.path}`,q(o,t)}function tn(e,t){let o=P(e);return o.path=`/fonts/v1${o.path}`,q(o,t)}function et(e,t){let o=P(e);return o.path=`/v4/${o.authority}.json`,o.params.push("secure"),q(o,t)}function on(e,t){let o=P(e),n=o.path.split(".");return o.path=`/styles/v1${n[0]}/sprite.${n[1]}`,q(o,t)}function Q(e){if(e.srid??="3857",e.srid!=="3857"){console.warn(`Layer ${e.key} must be set to use SRID 3857.`);return}mapp.layer.styleParser(e),e.params??={},e.mvt_cache&&console.warn(`Layer ${e.key} mvt_cache has been disabled.`),delete e.params.viewport,e.reload=t;function t(){if(e.wkt_properties){rt(e);return}e.source.clear(),e.source.refresh(),e.featureSource.refresh()}e.featureSource=new ol.source.VectorTile({cacheSize:0,format:new ol.format.MVT({featureClass:ol.Feature}),tileUrlFunction:ot(e),transition:0}),e.source=new ol.source.VectorTile({cacheSize:e.cacheSize||0,format:new ol.format.MVT,transition:e.transition}),e.wkt_properties?(e.source.setTileUrlFunction(nt(e)),e.changeEndCallbacks=[rt]):e.featureLookup?e.source.setTileUrlFunction(nt(e)):e.source.setTileUrlFunction(ot(e)),e.L=new ol.layer.VectorTile({className:`mapp-layer-${e.key}`,key:e.key,renderBuffer:200,source:e.source,style:mapp.layer.featureStyle(e),zIndex:e.zIndex})}function ot(e){return t=>{let o=e.tableCurrent();if(!o){e.source.clear();return}if(!e.display){e.source.clear();return}let n=e.geomCurrent();return e.params.fields=mapp.layer.featureFields.fieldsArray(e),`${e.mapview.host}/api/query?${mapp.utils.paramString({filter:e.filter?.current,geom:n,layer:e.key,locale:e.mapview.locale.key,table:o,template:"mvt",x:t[1],y:t[2],z:t[0],...e.params})}`}}function nt(e){return t=>{let o=e.tableCurrent();if(!o){e.source.clear();return}if(!e.display){e.source.clear();return}let n=e.geomCurrent();return`${e.mapview.host}/api/query?${mapp.utils.paramString({geom:n,layer:e.key,layer_template:e.params?.layer_template,locale:e.mapview.locale.key,srid:e.mapview.srid,table:o,template:"mvt",x:t[1],y:t[2],z:t[0]})}`}}async function rt(e){let t=e.tableCurrent();if(!t||!e.display){e.source.clear();return}let o=e.geomCurrent();e.params.fields=mapp.layer.featureFields.fieldsArray(e);let n=e.mapview.getBounds(),r=[n.west,n.south,n.east,n.north,e.mapview.srid],i=e.mapview.Map.getView().getZoom(),a=mapp.utils.paramString({filter:e.filter?.current,geom:o,layer:e.key,locale:e.mapview.locale.key,no_geom:!0,table:t,template:"wkt",viewport:r,z:i,...e.params}),s=`${e.mapview.host}/api/query?${a}`,l=await mapp.utils.xhr({url:s,debounce:{key:e.key,delay:500}});e.featuresObject={},Array.isArray(l)&&mapp.layer.featureFormats.wkt_properties(e,l),e.L.changed()}var it=e=>{e.source??="OSM",e.projection??="EPSG:3857",e.paramString??=mapp.utils.paramString(e.params),e.L=new ol.layer.Tile({className:`mapp-layer-${e.key}`,key:e.key,source:new ol.source[e.source]({projection:e.projection,transition:0,url:e.URI+e.paramString}),zIndex:e.zIndex}),e.style?.contextFilter&&(e.L.on("prerender",t=>{t.context&&(t.context.filter=e.style.contextFilter,t.context.globalCompositeOperation="source-over")}),e.L.on("postrender",t=>{t.context&&(t.context.filter="none")}))};function j(e){if(!e.srid){console.warn(`Vector Layer: ${e.key} missing SRID.`);return}if(!e.qID){console.warn(`Vector Layer: ${e.key} missing qID property.`);return}mapp.layer.styleParser(e),e.properties&&console.warn(`Layer: ${e.key}, layer.properties{} are no longer required for wkt & geojson datasets.`),e.params??={},e.params.fields??=[],e.featureFormat??=e.format,sn(e),e.setSource=async t=>{if(t===null){e.L.setSource(null),mapp.layer.featureFields.reset(e),mapp.layer.featureFields.process(e);return}if(t){if(e.Features=await mapp.layer.featureFormats[e.featureFormat](e,[t].flat()),e.source=new ol.source.Vector({features:e.Features}),delete e.xhr,e.fade&&mapp.layer.fade(e),e.cluster?.distance){e.cluster.source=new ol.source.Cluster({distance:e.cluster.distance,source:e.source}),e.L.setSource(e.cluster.source),e.cluster.source.on("change",o=>nn(o,e));return}e.L.setSource(e.source)}},e.reload=rn,e.L=new ol.layer[e.vectorImage&&"VectorImage"||"Vector"]({className:`mapp-layer-${e.key}`,key:e.key,style:e.styleFunction||mapp.layer.featureStyle(e),zIndex:e.zIndex}),e.setSource(e.features)}function nn(e,t){delete t.cluster.max_size;let o=t.cluster.source.getFeatures();if(!o.length)return;let n=o.map(r=>{let i=r.get("features");if(!i.length){console.error("Empty cluster feature detected.");return}if(r.set("id",i[0].get("id"),!0),i.length>1)r.set("count",i.length,!0);else{let a=i[0].getProperties();Object.entries(a).forEach(s=>{r.set(s[0],s[1],!0)})}return i.length});n.length&&(t.cluster.max_size=Math.max(...n))}function rn(){let e=this;if(e.features)return;let t=e.tableCurrent();if(!t)return;let o=e.geomCurrent();e.fade&&mapp.layer.fade(e,!0),e.params.fields=mapp.layer.featureFields.fieldsArray(e);let n=e.mapview.getBounds(e.srid);e.params.viewport&&=[n.west,n.south,n.east,n.north,e.srid],e.params.z&&=e.mapview.Map.getView().getZoom(),clearTimeout(e.timeout),e.timeout=setTimeout(()=>{e.xhr=mapp.utils.xhr(`${e.mapview.host}/api/query?${mapp.utils.paramString({filter:e.filter?.current,geom:o,layer:e.key,locale:e.mapview.locale.key,srid:e.srid,table:t,template:e.params.template||e.format,...e.params})}`).then(r=>{r instanceof Error||e.setSource(r)})},100)}function sn(e){if(typeof e.cluster=="object"){if(e.cluster.distance&&e.cluster.resolution){console.warn(`Layer: ${e.key}, cluster.distance and cluster.resolution are mutually exclusive. You cannot use them both on the same layer. Please remove one of them. `);return}if(!e.cluster.distance&&!e.cluster.resolution){console.warn(`Layer: ${e.key}, cluster.distance or cluster.resolution must be set.`);return}if(e.cluster.distance<1){console.warn(`Layer: ${e.key}, cluster.distance is less than 1 [pixel]. The cluster config will be removed.`),delete e.cluster;return}if(e.cluster.resolution){if(typeof e.cluster.resolution=="number")e.params.resolution=parseFloat(e.cluster.resolution);else{console.warn(`Layer: ${e.key}, cluster.resolution must be a number.`);return}if(e.srid==="4326"){console.warn(`Layer: ${e.key}, srid 4326 is not allowed for cluster.resolution layers.`);return}e.params.viewport=!0,e.params.z=!0,e.format="cluster",e.params.template??=e.cluster.hexgrid?"cluster_hex":"cluster"}}}var st={cluster:j,geojson:j,googleMapTiles:W,mapboxStyle:Y,maplibre:X,mvt:Q,tiles:it,vector:j,wkt:j};var ct=new Set(["anchor","scale","url","svg","type"]),at=new Set(["zIndex","strokeColor","strokeWidth","strokeOpacity","fillOpacity","fillColor","clusterScale","zoomInScale","zoomOutScale","highlightScale",...ct]);function ee(e){e.style??={},typeof e.style.highlight=="object"&&(e.style.highlight.zIndex??=1/0,e.style.highlight.highlightScale??=e.style.highlight.scale,delete e.style.highlight.scale),an(e),ln(e),lt(e.style.theme,e),e.style?.themes&&(Object.keys(e.style.themes).forEach(t=>{if(e.style.themes[t]===t){e.style.themes[t]=e.style.theme;return}if(e.style.themes[t].key=t,e.style.themes[t].skip){delete e.style.themes[t];return}e.style.themes[t].key=t,e.style.themes[t].title??=t,lt(e.style.themes[t],e)}),e.style.theme??=Object.keys(e.style.themes)[0],typeof e.style.theme=="string"&&(e.style.theme=e.style.themes[e.style.theme])),pn(e),e.style?.labels&&(Object.keys(e.style.labels).forEach(t=>{e.style.labels[t].key=t,e.style.labels[t].title??=t}),e.style.label??=Object.keys(e.style.labels)[0],typeof e.style.label=="string"&&(e.style.label=e.style.labels[e.style.label])),e.style?.icon_scaling?.fields&&(Object.keys(e.style.icon_scaling.fields).forEach(t=>{e.style.icon_scaling.fields[t].key=t,e.style.icon_scaling.fields[t].title??=t}),e.style.icon_scaling.field??=Object.values(e.style.icon_scaling.fields)[0]?.field)}function an(e){e.style.default||(console.warn(`Layer: ${e.key} has no implicit default style. Please add style.default.`),e.style.default=e.cluster?{icon:{type:"dot"}}:{fillColor:"#fff9",strokeColor:"#333"}),e.style.default.style&&(console.warn(`Layer: ${e.key} has a style object within the default style configuration.`),e.style.default=e.style.default.style,delete e.style.default.style),te(e.style.default),e.hover&&(console.warn(`Layer: ${e.key}, layer.hover{} should be defined within layer.style{}.`),e.style.hover=e.hover,delete e.hover),e.style.zIndex&&console.warn(`Layer: ${e.key}, layer.style.zIndex has been deprecated. Use layer.zIndex instead.`),e.icon_scaling&&(console.warn(`Layer: ${e.key}, layer.icon_scaling has been assigned to layer.style.icon_scaling`),e.style.icon_scaling??=e.icon_scaling)}function ln(e){e.cluster&&(e.style.default.icon||(e.style.default={icon:{type:"dot"}},console.warn(`Cluster Layer: ${e.key} has no default icon. 'Dot' will be assigned.`)),Object.keys(e.style.default).filter(t=>!["icon","scale"].includes(t)).forEach(t=>{console.warn(`Cluster Layer: ${e.key}; ${t} key removed from default style.`),delete e.style.default[t]}),e.style.cluster={clusterScale:1,icon:{type:"dot"},...e.style.cluster},e.style.cluster.zoomInScale&&(e.style.zoomInScale=e.style.cluster.zoomInScale,delete e.style.cluster.zoomInScale),e.style.cluster.zoomOutScale&&(e.style.zoomOutScale=e.style.cluster.zoomOutScale,delete e.style.cluster.zoomOutScale),Array.isArray(e.style.cluster.icon)?e.style.cluster.icon.forEach(C):C(e.style.cluster.icon))}function C(e){e.url??=e.svg,delete e.svg}function lt(e,t){if(typeof e=="object"){if(!Object.hasOwn(mapp.layer.themes,e.type)){console.warn(`Layer: ${t.key}; Theme Type: ${e.type} unavailable.`);return}typeof e.style=="object"&&(e.style={...structuredClone(t.style.default),...e.style},te(e.style)),typeof e.cat=="object"&&(e.categories=Object.keys(e.cat).map(o=>{let n=e.cat[o];return n.label??=o,n.value??=o,n}),delete e.cat),Array.isArray(e.cat_arr)&&(e.categories=e.cat_arr,delete e.cat_arr),cn(e),e.categories?.forEach(o=>{o.label??=o.value,o.icon&&(o.style={icon:o.icon},delete o.icon),un(o,t)}),e.type==="categorized"&&Array.isArray(e.fields)&&e.categories.forEach(o=>{e.fields.includes(o.field)||console.warn(`Layer: ${t.key}; Cat ${o.label} missed valid field.`),o.style.icon||(console.warn(`Layer: ${t.key}; Cat ${o.label} has invalid icon style.`),o.style.icon={type:"dot"})})}}function cn(e){e.type==="graduated"&&(["less_than","greater_than"].includes(e.graduated_breaks)||(e.graduated_breaks="less_than"),e.categories.forEach(t=>t.value=Number(t.value)),e.graduated_breaks==="less_than"?e.categories.sort((t,o)=>t.value>o.value?0:-1):e.categories.sort((t,o)=>t.value>o.value?-1:0))}function un(e,t){if(e.style??={},Array.isArray(e.style))return;e.icon&&(e.style={icon:e.icon},delete e.icon);let o=structuredClone(t.style.default);if(e.style.icon){if(Array.isArray(e.style.icon)){e.style.icon.forEach(C);return}if(e.style.icon.type||(C(e.style.icon),e.style.icon.url))return;o.icon&&!Array.isArray(o.icon)&&(e.style.icon={...o.icon,...e.style.icon});return}let n={};Object.keys(o).filter(r=>at.has(r)).forEach(r=>n[r]=o[r]),e.style={...n,...e.style},Object.keys(e).filter(r=>at.has(r)).forEach(r=>{e.style[r]=e[r],delete e[r]}),te(e.style),!e.style.icon&&o.icon&&(console.warn(`Layer:${t.key}, Failed to evaluate icon: ${JSON.stringify(e)}. Default icon will be assigned.`),e.style.icon=o.icon)}function te(e){if(Array.isArray(e.icon)){e.icon.forEach(C),e.icon.length===1&&(e.icon=e.icon[0]);return}e.icon||Object.keys(e).filter(t=>ct.has(t)).forEach(t=>{e.icon??={},e.icon[t]=e[t],delete e[t]}),e.icon&&C(e.icon)}function pn(e){e.style?.hovers&&(Object.keys(e.style.hovers).forEach(t=>{e.style.hovers[t].key=t,e.style.hovers[t].title??=t}),e.style.hover??=Object.keys(e.style.hovers)[0],typeof e.style.hover=="string"&&(e.style.hover=e.style.hovers[e.style.hover])),e.style?.hover&&(e.style.hover.method??=mapp.layer.featureHover)}function oe(e,t){t.style={...t.style,...e.style}}function ne(e,t){if(!t.properties||t.properties.features?.length>1)return;let o;if(Array.isArray(e.fields)){t.style.icon=e.fields.map(i=>{let a=t.properties[i],s=e.categories.find(l=>(l.value===encodeURIComponent(a)||l.value===a)&&l.field===i);if(s)return o||=Array.isArray(s.style.icon),s.style.icon}).filter(i=>!!i),o&&(t.style.icon=t.style.icon.flat());return}let n=t.properties[e.field],r=e.categories.find(i=>i.value===encodeURIComponent(n)||i.value===n);if(r){if(r.style===null){t.style=null;return}t.style={...t.style,...r.style}}}function re(e,t){e.lookup??={},e.boxes??=[],e.field??="id";let o=String(t.properties[e.field]);if(!o)return;if(e.lookup[o]){t.style=e.lookup[o].style;return}e.index===void 0?e.index=0:e.index++,e.index===e.categories.length&&(e.index=0);let n={extent:t.getGeometry().getExtent()};if(!n.extent)return;if(n.extent[0]===n.extent[2]&&n.extent[1]===n.extent[3]){e.lookup[o]=e.categories[e.index],e.categories[e.index].values??=[],e.categories[e.index].values.push(o),t.style=e.lookup[o].style;return}let r=e.boxes.filter(a=>!(n.extent[0]>a.extent[2]||n.extent[2]<a.extent[0]||n.extent[1]>a.extent[3]||n.extent[3]<a.extent[1]));e.boxes.push(n);let i=new Set(r.map(a=>a.themeIdx));if(i.has(e.index)){for(let a=0;a<e.categories.length;a++)if(!i.has(a)){n.themeIdx=a;break}}n.themeIdx??=e.index,e.lookup[o]=e.categories[n.themeIdx],e.categories[e.index].values??=[],e.categories[e.index].values.push(o),t.style=e.lookup[o].style}var fn={greater_than:e=>t=>e>=t.value,less_than:e=>t=>e<=t.value};function ie(e,t){if(!t.properties)return;let o=Array.isArray(t.properties.features)?t.properties.features.reduce((n,r)=>n+Number(r.getProperties()[e.field]),0):parseFloat(t.properties[e.field]);if(!isNaN(o)&&o!==null){let n=e.categories.findIndex(fn[e.graduated_breaks](o)),r=e.categories.at(n);if(r.style===null){t.style=null;return}t.style={...t.style,...r.style}}}var ut={decorate:G,fade:z,featureFields:K,featureFormats:J,featureHover:H,featureStyle:D,formats:st,Style:D,styleParser:ee,themes:{basic:oe,categorized:ne,distributed:re,graduated:ie}};async function se(e,t,o){if(!e)return;let n={layer:o,new:!0,table:o.tableCurrent()};t.default_fields&&(t.defaults??={},Object.entries(t.default_fields).forEach(r=>{t.defaults[r[0]]=t[r[1]]}));try{n.id=await mapp.utils.xhr({body:JSON.stringify({[o.geom]:e.geometry,...t?.defaults,...o.draw?.defaults}),method:"POST",url:`${o.mapview.host}/api/query?`+mapp.utils.paramString({layer:o.key,locale:o.mapview.locale.key,table:n.table,template:"location_new"})})}catch(r){console.error("Error saving location:",r),mapp.ui.elements.alert({text:mapp.dictionary.location_new_failed});return}if(o.format==="mvt"){let r=function(a){o.features=o.features.concat(a.tile.getFeatures())},i=function(){o.features?.find(s=>s.properties?.id===n.id)?o.source.un("tileloadend",r):o.reload()};o.features=[],o.source.on("tileloadend",r),setTimeout(i,1e3)}o.reload(),o.mapview.Map.getTargetElement().dispatchEvent(new CustomEvent("changeEnd")),mapp.location.get(n)}function ae(e){return Object.assign(e,{confirmUpdate:mn,getExtent:_n,flyTo:yn,Layers:[],removeLayer:bn,remove:dn,removeCallbacks:[],removeEdits:xn,restoreEdits:vn,syncFields:gn,trash:wn,update:hn,updateCallbacks:[]}),e}function dn(){delete this.remove,this.layer.mapview.hooks&&mapp.hooks.filter("locations",this.hook),delete this.layer.mapview.locations[this.hook],this.view instanceof HTMLElement&&this.view.remove(),this.Layers?.forEach(e=>this.removeLayer(e)),this.layer.mapview.interaction?.type!=="highlight"&&this.layer.mapview.interactions.highlight(),this.layer?.reload?.(),this.removeCallbacks?.forEach(e=>typeof e=="function"&&e(this))}async function mn(e){if(this.infoj.some(o=>typeof o.newValue<"u"))return await mapp.ui.elements.confirm({text:mapp.dictionary.location_save_changes})?(await this.update(e),!0):null}async function hn(e){if(this.infoj.some(r=>r.invalid))return mapp.ui.elements.alert({text:mapp.dictionary.invalid_entry_value}),new Error("Unable to update.");this.infoj.filter(r=>r.jsonb_key).filter(r=>r.jsonb_field).filter(r=>typeof r.newValue<"u").forEach(r=>{r.newValue={jsonb:{[r.jsonb_field]:{[r.jsonb_key]:r.newValue}}}}),this.infoj.filter(r=>r.json_field).filter(r=>r.json_key).filter(r=>typeof r.newValue<"u").forEach(r=>{let i=this.infoj.find(a=>a.field===r.json_field);i.newValue??=i.value||{},i.newValue[r.json_key]=r.newValue,delete r.newValue});let t=Object.fromEntries(this.infoj.filter(r=>typeof r.newValue<"u").map(r=>[r.field,r.newValue]));if(!Object.keys(t).length)return;if(await mapp.utils.xhr({body:JSON.stringify(t),method:"POST",url:`${this.layer.mapview.host}/api/query?`+mapp.utils.paramString({id:this.id,layer:this.layer.key,locale:this.layer.mapview.locale.key,table:this.table,template:"location_update"})})instanceof Error){mapp.ui.elements.alert({text:mapp.dictionary.location_update_failed}),this.view?.classList.remove("disabled");return}let n=this.infoj.filter(r=>typeof r.newValue<"u").map(r=>(r.value=r.newValue,delete r.newValue,Array.isArray(r.dependents_layers)&&r.dependents_layers.forEach(i=>{let a=r.location.layer.mapview.layers[i];a&&a.reload()}),r.dependents)).flat().filter(r=>r!==void 0);if(n.length&&await this.syncFields([...new Set(n)]),this.layer.reload(),this.layer.mapview.interactions.highlight(),e instanceof Function){e(this);return}this.updateCallbacks?.forEach(r=>typeof r=="function"&&r(this))}async function gn(e){Array.isArray(e)||(e=[e]);let t=await mapp.utils.xhr(`${this.layer.mapview.host}/api/query?`+mapp.utils.paramString({fields:e.join(),id:this.id,layer:this.layer.key,locale:this.layer.mapview.locale.key,table:this.table,template:"location_get"}));if(!t||t instanceof Error){console.warn("No data returned from location_get request using ID:",this.id);return}else if(Array.isArray(t)){console.warn(`Location response returned more than one record for Layer: ${this.layer.key}.`),console.log("Location Get Response:",t);return}this.infoj.filter(o=>typeof t[o.field]<"u").forEach(o=>{o.value=t[o.field]})}async function yn(e){let t=await this.getExtent();t&&this.layer.mapview.fitView(t,{maxZoom:e})}function bn(e){e.L&&(this.Layers=this.Layers.filter(t=>t.L.ol_uid!==e.L.ol_uid),this.layer.mapview.Map.removeLayer(e.L),delete e.L)}async function wn(){await mapp.ui.elements.confirm({text:mapp.dictionary.confirm_delete})&&(await mapp.utils.xhr(`${this.layer.mapview.host}/api/query?`+mapp.utils.paramString({id:this.id,layer:this.layer.key,locale:this.layer.mapview.locale.key,table:this.table,template:"location_delete"})),this.remove())}function xn(){this.infoj.forEach(e=>{e.edit&&(delete e.newValue,e._edit=e.edit,delete e.edit)})}function vn(){this.infoj.forEach(e=>{e._edit&&(e.edit=e._edit,delete e._edit)})}async function _n(){let e=ol.extent.createEmpty();for(let t of this.Layers){if(!t.display)continue;let o=await t.getExtent();Array.isArray(o)&&ol.extent.extend(e,o)}return e.every(t=>isFinite(t))?e:null}var V=new Set;async function pt(e,t=e.layer.mapview.locations){let o=e.layer.mapview;if(o.interaction?.getLocation instanceof Function){o.interaction?.getLocation(e);return}if(!(!e.layer||!e.id)&&e.layer.infoj){if(e.layer.params?.layer_template&&(e.layer.key=e.layer.params.layer_template),e.hook??=`${e.layer.key}!${e.id}`,t[e.hook]){t[e.hook].remove(),delete t[e.hook];return}if(!V.has(e.hook)){if(V.add(e.hook),e.locale??=o.locale.key,!await le(e)){V.delete(e.hook),delete t[e.hook];return}return mapp.location.decorate(e),V.delete(e.hook),t[e.hook]=e,o.hooks&&mapp.hooks.push("locations",e.hook),e}}}async function le(e){if(!e.layer){console.warn("No layer provided for getLocationInfoj()");return}typeof e.layer=="string"&&(e.layer=await mapp.utils.xhr(`${mapp.host}/api/workspace/layer?locale=${e.locale}&layer=${e.layer}`)),e.getTemplate??="location_get",e.table??=e.layer.table||e.layer.tables&&Object.values(e.layer.tables).find(o=>!!o);let t=await kn(e);if(!t||t instanceof Error){let o=`Get location query for ID:${e.id} on layer: "${e.layer.name}" has failed.`;console.warn(o,t),mapp.ui.elements.alert({text:o});return}else if(Array.isArray(t)){let o=`Get location query for ID:${e.id} on layer: "${e.layer.name}" returned ${t.length} records.`;console.warn(o,t),mapp.ui.elements.alert({text:o});return}return e.layer.infoj??=[{field:e.layer.qID}],e.infoj=e.layer.infoj?.map(o=>({...structuredClone(o),location:e,title:o.title||t[o.field+"_label"],value:t[o.field]})),e.infoj}async function kn(e){if(e.layer.featureLocation){let r=e.layer.features.find(i=>i.properties[e.layer.qID]===e.id);return r?{geometry:r.geometry,...r.properties}:null}let t={id:e.id,layer:e.layer.key,layer_template:e.layer.params?.layer_template,locale:e.locale,table:e.table,template:e.getTemplate},o=`${mapp.host}/api/query?${mapp.utils.paramString(t)}`,n;try{n=await mapp.utils.xhr(o)}catch(r){return r}return n}async function ce(e){let t=e.feature.getProperties(),n=e.feature.getGeometry().getCoordinates(),r=ol.proj.transform(n,`EPSG:${e.mapview.srid}`,`EPSG:${e.layer.srid}`),a=(await mapp.utils.xhr(`${e.mapview.host}/api/query/get_nnearest?`+mapp.utils.paramString({coords:r,filter:e.layer.filter?.current,geom:e.layer.geom,label:e.layer.cluster?.label||e.layer.qID,layer:e.layer.key,locale:e.mapview.locale.key,n:t.count>(e.max||99)?e.max||99:t.count,qID:e.layer.qID,table:e.table,x:r[0],y:r[1]}))).map(l=>mapp.utils.html.node`<li 
    onclick=${c=>{e.mapview.popup(null),mapp.location.get({id:l.id,layer:e.layer,marker:ol.proj.transform(l.coords,"EPSG:"+e.layer.srid,"EPSG:"+e.mapview.srid),table:e.table})}}>${l.label||'"'+e.layer.cluster?.label+'"'}`),s=mapp.utils.html.node`<ul class="list">${a}`;e.mapview.popup({autoPan:!0,content:s,coords:ol.proj.transform(r,"EPSG:"+e.layer.srid,"EPSG:"+e.mapview.srid)})}var ft={create:se,decorate:ae,get:pt,getInfoj:le,nnearest:ce};async function ue(e){e instanceof Object&&!Array.isArray(e)&&(e=[e]);let t=this.hooks&&new Set(mapp.hooks.current.layers);e=structuredClone(e),this.zIndex??=1;for(let o of e)o.err&&console.error(o.err),o.zIndex??=this.zIndex++,o.mapview=this,t?.size&&(o.display=t.has(o.key)),await mapp.layer.decorate(o),o.L&&(this.layers[o.key]=o,o.display&&o.show());return this.renderComplete=new Promise(o=>{this.Map.once("rendercomplete",o)}),e}function pe(e,t){t.popup(null);let o=[],n=(s,l)=>{let c={F:s,id:s.get("id")||s.getId(),L:l,layer:t.layers[l.get("key")]};o.push(c)},r={hitTolerance:t.interaction.hitTolerance,layerFilter:t.interaction.layerFilter};if(t.Map.forEachFeatureAtPixel(e.pixel,n,r),!o.length)return;let i=o.map(s=>mapp.utils.html`
    <li onclick=${l=>{t.interaction.getFeature(s),t.popup(null)}}>${s.L.get("key")} [${s.id}]`),a=mapp.utils.html.node`<ul class="list">${i}`;t.popup({autoPan:!0,content:a})}function fe(e){typeof e.attribution=="object"&&(e.attribution.target??=e.target,e.attribution.node=mapp.utils.html.node`
    <div class="map-attribution">${e.attribution.logo}`,e.attribution.target.append(e.attribution.node),e.attribution.linksTarget=mapp.utils.html.node`<div class="attribution-links">`,e.attribution.node.append(e.attribution.linksTarget),e.attribution.links??={},e.attribution.check=()=>{let t=structuredClone(e.attribution.links);Object.values(e.layers).filter(n=>!!n.display).filter(n=>!!n.attribution).forEach(n=>Object.assign(t,n.attribution));let o=Object.entries(t).map(n=>mapp.utils.html`
      <a target="_blank" href="${n[1]}">${n[0]}`);mapp.utils.render(e.attribution.linksTarget,mapp.utils.html.node`${o}`)})}function dt(e,t={}){if(!Array.isArray(e)||!e.every(o=>isFinite(o))){console.warn("Attempted to call fitView method with invalid extent");return}this.Map.getView().fit(e,{duration:1e3,padding:[50,50,50,50],...t})}function mt(e){return e.format="GeoJSON",this.geometry(e)}var ht;function gt(e){typeof e.format=="string"&&Object.hasOwn(ol.format,e.format)&&(ht=new ol.format[e.format]);let t,o=e.geometry||(typeof e.value=="string"?JSON.parse(e.value):e.value);if(e.Style??=mapp.utils.style(e.style),!o)return;try{t=ht.readFeature({geometry:o,type:"Feature"},{dataProjection:`EPSG:${e.dataProjection||e.srid||this.srid}`,featureProjection:`EPSG:${this.srid}`})}catch(r){console.error(r);return}if(!t)return;let n=new ol.layer.Vector({source:new ol.source.Vector({features:[t]}),style:e.Style,zIndex:e.zIndex});return this.Map.addLayer(n),n}function de(e){let t=this.Map.getView().calculateExtent();if(!e)return{east:t[2],north:t[3],south:t[1],west:t[0]};let o=ol.proj.transformExtent(t,`EPSG:${this.srid}`,`EPSG:${e}`);return{east:o[2],north:o[3],south:o[1],west:o[0]}}var v={};function yt(e){let t=this;if(v.node?.remove(),!t.position||(t.Map.un("pointermove",o),!e))return;if(e instanceof HTMLElement)v.node=e;else if(typeof e=="object"){console.warn(`Content type object cannot be rendered in infotip: ${JSON.stringify(e)}`);return}else t.locale.xss_check&&/[()]/.test(e)&&console.warn(`Potential XSS detected in infotip content ${e}`),v.node=mapp.utils.html.node`<div class="infotip box-shadow">`,v.node.innerHTML=e;t.Map.getTargetElement().append(v.node),t.Map.on("pointermove",o),o();function o(){v.node.style.opacity=1,v.node.style.left=t.pointerLocation.x-v.node.offsetWidth/2+"px",v.node.style.top=t.pointerLocation.y-v.node.offsetHeight-15+"px"}}function bt(e){let t=this;t.interaction?.finish(),t.interaction={condition:i=>{if(t.interaction.wait)return!1;if(i.originalEvent.buttons===2){t.interaction.interaction.removeLastPoint(),t.interaction.vertices.pop();let a=new ol.MapBrowserEvent("pointermove",t.Map,i.originalEvent);return t.interaction.interaction.handleEvent(a),t.interaction.conditions?.forEach(s=>typeof s=="function"&&s(i)),!1}if(i.originalEvent.buttons===1)return t.interaction.vertices.push(i.coordinate),t.popup(null),t.interaction.conditions?.forEach(a=>typeof a=="function"&&a(i)),!0},drawend:mapp.ui?.elements.contextMenu.draw.bind(this),finish:r,format:new ol.format.GeoJSON,getFeature:n,Layer:new ol.layer.Vector({zIndex:e.layer?.zIndex||99}),source:new ol.source.Vector,style:[new ol.style.Style({stroke:new ol.style.Stroke({color:"#3399CC",width:1.25})}),new ol.style.Style({geometry:mapp.utils.verticeGeoms,image:new ol.style.Circle({fill:new ol.style.Fill({color:"#eee"}),radius:5,stroke:new ol.style.Stroke({color:"#3399CC",width:1.25})})})],type:"draw",vertices:[],...e},t.Map.getTargetElement().style.cursor="crosshair",t.interaction.Layer.setSource(t.interaction.source),t.Map.addLayer(t.interaction.Layer),document.addEventListener("keyup",o);function o(i){i.key==="Escape"&&t.interaction.finish()}t.interaction.interaction=new ol.interaction.Draw(t.interaction),t.interaction.interaction.on("drawstart",i=>{let a=i.feature.getGeometry();async function s(){t.popup({content:mapp.utils.html.node`
          <div style="padding: 5px">
          ${await mapp.utils.convert(t.metrics[t.interaction.tooltip.metric](a),t.interaction.tooltip)}`})}t.interaction.tooltip&&a.on("change",t.interaction.tooltip.onChange||s),t.interaction.source.clear(),t.popup(null)}),typeof t.interaction.drawend=="function"&&t.interaction.interaction.on("drawend",t.interaction.drawend),t.Map.addInteraction(t.interaction.interaction),t.interactions.snap(t);function n(){return JSON.parse(t.interaction.format.writeFeature(t.interaction.source.getFeatures()[0],{dataProjection:"EPSG:"+t.interaction.layer?.srid||t.interaction.srid||t.srid,featureProjection:"EPSG:"+t.srid}))}function r(i){document.removeEventListener("keyup",o),t.interaction.snap?.remove?.(),t.Map.getTargetElement().style.cursor="default",t.popup(null),t.Map.removeInteraction(t.interaction.interaction),t.Map.removeLayer(t.interaction.Layer),t.interaction.callback?.(i)}}function me(e){let t=this;t.interaction?.finish(),t.interaction={candidateKeys:new Set,candidates:{},finish:f,getFeature:u,hitTolerance:5,layerFilter:o,longClickMethod:t.allFeatures,longClickMS:500,type:"highlight",...e},t.Map.on("pointermove",s),t.Map.on("click",l),t.Map.getTargetElement().addEventListener("mousedown",i),t.Map.getTargetElement().addEventListener("touchstart",r),t.Map.getTargetElement().addEventListener("mouseup",a),t.Map.getTargetElement().addEventListener("mouseleave",n);function o(p){return Object.values(t.layers).some(d=>d.qID&&d.L===p)}function n(){t.interaction.candidateKeys=new Set,c()}function r(p){p.preventDefault()}function i(){t.interaction.longClickMethod&&(delete t.interaction.longClick,t.interaction.longClickTimeout&&clearTimeout(t.interaction.longClickTimeout),t.interaction.longClickTimeout=setTimeout(()=>{t.interaction.longClick=!0,t.Map.getTargetElement().style.cursor="wait"},t.interaction.longClickMS))}function a(){t.Map.getTargetElement().style.cursor="auto"}function s(p){t.interaction.longClickTimeout&&clearTimeout(t.interaction.longClickTimeout);let d={},m=(b,w)=>{let I=w.get("key")||ol.util.getUid(w),Eo=b.get("id")||b.getId()||ol.util.getUid(b),Je=`${I}!${Eo}`;d[Je]={F:b,key:Je,L:w}},x={hitTolerance:t.interaction.hitTolerance,layerFilter:t.interaction.layerFilter};if(t.Map.forEachFeatureAtPixel(p.pixel,m,x),!Object.keys(d).length){t.interaction.candidateKeys.clear(),c();return}if(mapp.utils.areSetsEqual(t.interaction.candidateKeys,new Set(Object.keys(d))))return;let h=d[Object.keys(d).find(b=>!t.interaction.candidateKeys.has(b))]||t.interaction.current?.key&&d[t.interaction.current?.key]||d[Object.keys(d)[0]];if(t.interaction.candidateKeys=new Set(Object.keys(d)),t.interaction.current?.key!==h.key){if(c(),h.layer=t.layers[h.L.get("key")],h.id=h.F.get("id")||h.F.getId(),h.layer.highlight=h.id,t.interaction.current=h,p.originalEvent.pointerType!=="mouse"){p.type!=="pointermove"&&t.interaction.getFeature(h),c();return}h.layer.infoj&&(t.Map.getTargetElement().style.cursor="pointer"),typeof h.layer.style?.hover?.method=="function"&&h.layer.style.hover.method(h.F,h.layer),t.interaction.current.layer.L.changed()}}function l(p){if(t.Map.getTargetElement().style.cursor="auto",clearTimeout(t.interaction.longClickTimeout),t.interaction.longClick){t.interaction.longClickMethod(p,t);return}if(!t.interaction.clicked){if(t.interaction.clicked=setTimeout(()=>{t.interaction.clicked=null},600),p.originalEvent.pointerType==="touch"){t.interaction.candidateKeys=new Set,p.type="touchClick",s(p);return}if(t.popup(null),typeof t.interaction.Click=="function"){t.interaction.Click(p);return}if(!t.interaction.current&&typeof t.interaction.noLocationClick=="function"){t.interaction.noLocationClick(p);return}t.interaction.current&&t.interaction.getFeature(t.interaction.current)}}function c(){t.interaction.current&&(t.infotip(null),t.Map.getTargetElement().style.cursor="auto",delete t.interaction.current.layer.highlight,t.interaction.current.layer.L.changed(),delete t.interaction.current)}function u(p){if(p.F.getProperties().count>1){let m=p.F.get("features");if(Array.isArray(m)){let h=m.map(w=>{let I=w.getProperties();return{id:I.id,label:I[p.layer.cluster?.label]}}).map(w=>mapp.utils.html.node`<li
          onpointerup=${I=>{t.popup(null),mapp.location.get({id:w.id,layer:p.layer,table:p.layer.table||p.layer.tableCurrent()})}}>${w.label||w.id}`),b=mapp.utils.html.node`<ul class="list">${h}`;t.popup({autoPan:!0,content:b,coords:p.F.getGeometry().getCoordinates()});return}mapp.location.nnearest({feature:p.F,layer:p.layer,mapview:t,table:p.layer.table||p.layer.tableCurrent()});return}mapp.location.get({id:p.id,layer:p.layer,table:p.layer.table||p.layer.tableCurrent()})}function f(){c(),t.popup(null),t.Map.un("pointermove",s),t.Map.un("click",l),t.Map.getTargetElement().removeEventListener("mousedown",i),t.Map.getTargetElement().removeEventListener("touchstart",r),t.Map.getTargetElement().removeEventListener("mouseup",a),t.Map.getTargetElement().removeEventListener("mouseleave",n),t.interaction.callback?.()}}function he(e){let t=this;t.interaction?.finish(),t.interaction={deleteCondition:i=>{if(i.type==="singleclick"){let a=t.interaction.Feature.getGeometry(),s=a.getType();if(s==="Point")return;let l=a.getCoordinates();if(s==="LineString"&&l.length<3||s==="Polygon"&&l[0].length<=4)return;t.popup({content:mapp.utils.html.node`<ul>
            <li
              onclick=${()=>{t.interaction.interaction.removePoint(),t.interaction.vertices.push(t.interaction.Feature.getGeometry().getClosestPoint(i.coordinate))}}>${mapp.dictionary.delete_vertex}`,coords:a.getClosestPoint(i.coordinate)})}},finish:r,format:new ol.format.GeoJSON,getFeature:n,Layer:new ol.layer.Vector({zIndex:1/0}),modifyend:mapp.ui?.elements.contextMenu.modify.bind(this),Style:[new ol.style.Style({image:new ol.style.Circle({radius:5,stroke:new ol.style.Stroke({color:"#3399CC",width:1.25})}),stroke:new ol.style.Stroke({color:"#3399CC",width:1.25})}),new ol.style.Style({geometry:mapp.utils.verticeGeoms,image:new ol.style.Circle({fill:new ol.style.Fill({color:"#eee"}),radius:5,stroke:new ol.style.Stroke({color:"#3399CC",width:1.25})})})],source:new ol.source.Vector,type:"modify",vertices:[],...e},t.Map.getTargetElement().style.cursor="crosshair",t.interaction.source.addFeature(t.interaction.Feature),t.interaction.Layer.setSource(t.interaction.source),t.interaction.Layer.setStyle(t.interaction.Style),t.Map.addLayer(t.interaction.Layer),document.addEventListener("keyup",o);function o(i){i.key==="Escape"&&t.interaction.finish()}t.interaction.interaction=new ol.interaction.Modify(t.interaction),t.interaction.interaction.on("modifystart",i=>{t.popup(null)}),typeof t.interaction.modifyend=="function"&&t.interaction.interaction.on("modifyend",t.interaction.modifyend),t.Map.addInteraction(t.interaction.interaction),t.interactions.snap(t);function n(){return JSON.parse(t.interaction.format.writeFeature(t.interaction.Feature,{dataProjection:"EPSG:"+t.interaction.srid||t.srid,featureProjection:"EPSG:"+t.srid}))}function r(i){document.removeEventListener("keyup",o),t.interaction.snap?.remove?.(),t.Map.getTargetElement().style.cursor="default",t.popup(null),t.Map.removeInteraction(t.interaction.interaction),t.interaction.source.clear(),t.Map.removeLayer(t.interaction.Layer),t.interaction.callback?.(i)}}function wt(e){if(!e.interaction.snap)return;if(e.interaction.snap===!0&&(e.interaction.snap={layer:e.interaction.layer.key}),typeof e.interaction.snap=="string"&&(e.interaction.snap={layer:e.interaction.snap}),e.interaction.snap={remove:()=>{e.interaction.layer.featureSource&&(e.interaction.layer.featureSource.un("tileloadend",t),e.Map.removeLayer(e.interaction.snap.vectorTileLayer),e.interaction.layer.featureSource.clear()),e.Map.removeInteraction(e.interaction.snap.interaction)},...e.interaction.snap},!e.layers[e.interaction.snap.layer]){console.warn(`Unable to snap to layer:${e.interaction.snap.layer} as it is not found in mapview.layers.`);return}e.interaction.snap.layer&&=e.layers[e.interaction.snap.layer]||e.interaction.layer,e.interaction.snap.layer??=e.interaction.layer,e.interaction.snap.layer.show();function t(o){let n=o.tile.getFeatures();try{e.interaction.snap.source.addFeatures(n)}catch{}}e.interaction.snap.layer.featureSource?(e.interaction.snap.source=new ol.source.Vector,e.interaction.snap.layer.featureSource.on("tileloadend",t),e.interaction.snap.vectorTileLayer=new ol.layer.VectorTile({opacity:0,source:e.interaction.snap.layer.featureSource}),e.Map.addLayer(e.interaction.snap.vectorTileLayer)):e.interaction.snap.source=e.interaction.snap.layer.L.getSource(),e.interaction.snap.interaction=new ol.interaction.Snap({source:e.interaction.snap.source}),e.Map.addInteraction(e.interaction.snap.interaction)}function xt(e){let t=this;t.interaction?.finish(),t.interaction={finish:o,Layer:new ol.layer.Vector({source:new ol.source.Vector}),...e},t.interaction.Layer.getSource().clear(),t.Map.addLayer(t.interaction.Layer),t.Map.getTargetElement().style.cursor="zoom-in",t.interaction.interaction=new ol.interaction.Draw({geometryFunction:ol.interaction.Draw.createBox(),source:t.interaction.Layer.getSource(),style:{"fill-color":"#fff9","stroke-color":"#ddd"},type:"Circle"}),t.interaction.interaction.on("drawend",n=>{t.fitView(n.feature.getGeometry().getExtent()),o()}),t.Map.addInteraction(t.interaction.interaction);function o(){t.Map.getTargetElement().style.cursor="auto",t.Map.removeInteraction(t.interaction.interaction),t.Map.removeLayer(t.interaction.Layer),t.interaction.Layer.getSource().clear(),t.interaction.callback?.()}}function ge(e){if(this._locate??={feature:new ol.Feature({geometry:new ol.geom.Point([0,0])}),icon:{scale:.05,svg:`${this.host}/icons/locator.svg`},...e},this._locate.active=!this._locate.active,this._locate.L||(this._locate.L=new ol.layer.Vector({source:new ol.source.Vector({features:[this._locate.feature]}),style:mapp.utils.style({icon:this._locate.icon}),zIndex:999})),!this._locate.active){this.Map.removeLayer(this._locate.L);return}this.Map.addLayer(this._locate.L),mapp.utils.getCurrentPosition(t=>{let o=ol.proj.fromLonLat([parseFloat(t.coords.longitude),parseFloat(t.coords.latitude)]);this._locate.feature.getGeometry().setCoordinates(o),this.Map.getView().animate({center:o,zoom:this.locale.maxZoom})})}var _={};function vt(e){if(typeof e>"u")return _.node?.parentNode;let t=this;t.infotip(null),_.node?.remove(),e&&(_.node=mapp.utils.html.node`<div class="popup box-shadow">`,_.node.appendChild(e.content),_.overlay&&t.Map.removeOverlay(_.overlay),_.overlay=new ol.Overlay({autoPan:e.autoPan,autoPanAnimation:{duration:250},element:_.node,insertFirst:!0,position:e.coords||t.position,positioning:"bottom-center"}),t.Map.addOverlay(_.overlay))}function ye(e){Array.isArray(e)||(e=[e]);for(let t of e)(typeof t=="string"?this.layers[t]:t).remove();this.renderComplete=new Promise(t=>{this.Map.once("rendercomplete",t)})}function be(e){if(!e.locale){console.warn("A locale property is required to decorare a mapview object.");return}if(!e.target){console.warn("A target is required for the mapview Map creation.");return}mapp.utils.keyvalue_dictionary(e.locale),e.host??=mapp.host,Object.assign(e,{addLayer:ue,allFeatures:pe,changeEnd:$n,changeEndCallbacks:[_t],fitView:dt,geoJSON:mt,geometry:gt,getBounds:de,infotip:yt,interactions:{draw:bt.bind(e),highlight:me.bind(e),modify:he.bind(e),snap:wt,zoom:xt.bind(e)},layers:{},locate:ge,locations:{},metrics:{area:o=>ol.sphere.getArea(o),distance:o=>ol.sphere.getLength(new ol.geom.LineString([o.getInteriorPoint().getCoordinates(),e.position])),length:o=>ol.sphere.getLength(o)},popup:vt,removeLayer:ye,srid:e.locale.srid||"3857"}),Sn(e),Cn(e),e.Map=new ol.Map({controls:e.controls,interactions:ol.interaction.defaults.defaults({mouseWheelZoom:e.scrollWheelZoom&&{duration:250,timeout:80}||!1,pinchRotate:e.pinchRotate&&{threshold:3}||!1}),moveTolerance:5,target:e.target,view:new ol.View(e.view)}),e.target=e.Map.getTargetElement(),_t(e);let t;return new ResizeObserver(()=>{t&&clearTimeout(t),t=setTimeout(()=>{e.target.dispatchEvent(new Event("resize"))},400)}).observe(e.target),En(e),fe(e),e.Map.on("pointermove",o=>{e.position=o.coordinate,e.pointerLocation={x:o.originalEvent.clientX,y:o.originalEvent.clientY}}),e.target.addEventListener("mouseout",()=>{e.infotip(null),e.position=null,e.pointerLocation={x:null,y:null}}),e.target.addEventListener("changeEnd",()=>e.changeEnd()),e.Map.on("moveend",()=>e.target.dispatchEvent(new Event("changeEnd"))),e.locale.svgTemplates??=e.locale.svg_templates,e.locale.syncPlugins?.length||e.locale.svgTemplates?Ln(e):e}function Sn(e){e.view??=e.locale.view||{},e.view.projection=`EPSG:${e.srid}`,e.view.minZoom??=e.locale.minZoom||0,e.view.maxZoom??=e.locale.maxZoom,e.view.z=mapp.hooks?.current?.z||e.view.z||e.view.minZoom,e.view.zoom=e.view.z,e.view.center=ol.proj.fromLonLat([Number.parseFloat(mapp.hooks?.current?.lng||e.view?.lng||0),Number.parseFloat(mapp.hooks?.current?.lat||e.view?.lat||0)]),jn(e)}function jn(e){e.locale.bounds&&(console.warn("locale.bounds have been renamed to locale.extent"),e.locale.extent=e.locale.bounds);let t=Number.parseFloat(e.locale.extent?.north||90),o=Number.parseFloat(e.locale.extent?.south||-90),n=Number.parseFloat(e.locale.extent?.east||180),r=Number.parseFloat(e.locale.extent?.west||-180);t-o>=0&&n-r>=0?e.view.extent=ol.proj.transformExtent([r,o,n,t],"EPSG:4326",`EPSG:${e.srid}`):(console.warn("Invalid extent. Ensure north >= south and east >= west. Global extent is assumed."),e.view.extent=ol.proj.transformExtent([-180,-90,180,90],"EPSG:4326",`EPSG:${e.srid}`)),e.extent=e.view.extent}function Cn(e){e.controls=e.locale.mapviewControls?.filter(t=>Object.hasOwn(ol.control,t)).map(t=>new ol.control[t])||[],e.locale.showScaleBar&&(e.locale.ScaleLine??="metric"),e.locale.scalebar&&(e.locale.ScaleLine??=e.locale.scalebar),e.locale.ScaleLine&&(e.locale.ScaleLine=e.locale.ScaleLine==="imperial"?"imperial":"metric",e.controls.push(new ol.control.ScaleLine({units:e.locale.ScaleLine})))}function En(e){if(e.locale.maskBounds&&console.warn("locale.maskBounds is set as mask:true in locale.extent"),!e.locale.extent?.mask)return;let t=[[180,90],[180,-90],[-180,-90],[-180,90],[180,90]],o=[[e.locale.extent.east,e.locale.extent.north],[e.locale.extent.east,e.locale.extent.south],[e.locale.extent.west,e.locale.extent.south],[e.locale.extent.west,e.locale.extent.north],[e.locale.extent.east,e.locale.extent.north]],n=new ol.Feature({geometry:new ol.geom.Polygon([t,o]).transform("EPSG:4326",`EPSG:${e.srid}`)});e.Map.addLayer(new ol.layer.Vector({source:new ol.source.Vector({features:[n]}),style:{"fill-color":"#0004"},zIndex:1/0}))}function $n(){clearTimeout(this.changeEndTimer),this.changeEndTimer=setTimeout(()=>{for(let e of this.changeEndCallbacks)typeof e=="function"&&e(this);for(let e of Object.values(this.layers))typeof e.changeEnd=="function"&&e.changeEnd()},400)}function _t(e){e.view.z=Math.round((e.Map.getView().getZoom()+Number.EPSILON)*100)/100,e.view.center=ol.proj.transform(e.Map.getView().getCenter(),`EPSG:${e.srid}`,"EPSG:4326"),e.view.lat=Math.round((e.view.center[1]+Number.EPSILON)*1e5)/1e5,e.view.lng=Math.round((e.view.center[0]+Number.EPSILON)*1e5)/1e5,e.hooks&&mapp.hooks.set({lat:e.view.lat,lng:e.view.lng,z:e.view.z})}async function Ln(e){if(await mapp.utils.svgTemplates(e.locale.svgTemplates),mapp.language!=="en"&&!Object.hasOwn(mapp.dictionaries,mapp.language)&&await mapp.utils.loadDictionary(mapp.language),e.locale.plugins??=[],Array.isArray(e.locale.layers))for(let n of e.locale.layers)Array.isArray(n.plugins)&&(e.locale.plugins=n.plugins.concat(e.locale.plugins));e.locale.plugins=[...new Set(e.locale.plugins)],e.loadPlugins&&await mapp.utils.loadPlugins(e.locale.plugins,Array.isArray(e.loadPlugins)?e.loadPlugins:void 0),e.locale.syncPlugins??=[];let t=new Set(e.locale.syncPlugins);for(let n of e.locale.syncPlugins)typeof mapp.plugins[n]=="function"&&await mapp.plugins[n](e.locale[n],e);let o=Object.keys(e.locale).filter(n=>!t.has(n)).filter(n=>typeof mapp.plugins[n]=="function").map(n=>mapp.plugins[n](e.locale[n],e));return await Promise.all(o),e}function kt(e,t){let o=t.mapButton;o&&mapp.user?.admin&&o.appendChild(mapp.utils.html.node`
    <a
      title=${mapp.dictionary.toolbar_admin}
      href="${mapp.host+"/api/user/admin"}">
      <span class="notranslate material-symbols-outlined">supervisor_account`)}function St(e,t){if(!t.mapButton)return;let o=mapp.user?.dark_mode;o&&mapp.ui.utils.cssColour.setTheme(mapp.ui.utils.cssColour.themes.dark);let n=mapp.utils.html.node`<button
    title=${mapp.dictionary.dark_mode}
    data-id="dark_mode"
    class="btn-color-mode"
    onclick=${()=>{o=!o,mapp.user&&(mapp.user.dark_mode=o,In());let r=o?mapp.ui.utils.cssColour.themes.dark:{};mapp.ui.utils.cssColour.setTheme(r);let i=n.querySelector("span");i.textContent=o?"light_mode":"dark_mode"}}>
    <span class="notranslate material-symbols-outlined">${o?"light_mode":"dark_mode"}`;t.mapButton.append(n)}async function In(){let e={...mapp.user};delete e.roles,delete e.admin,delete e.blocked,await mapp.utils.userIndexedDB.put({store:"user",name:mapp.user.email,obj:e})}function jt(e){mapp.ui.utils.cssColour.setTheme(e)}function Ct(e,t){let o=t.mapButton;o&&(e===!0&&(e={}),e.btn=mapp.utils.html.node`<button
    title=${mapp.dictionary.feature_info}
    data-id="feature_info"
    onclick=${()=>On(e,t)}>
    <span class="notranslate material-symbols-outlined">left_click`,o.append(e.btn))}function On(e,t){e.btn.firstElementChild.classList.toggle("active")?t.interactions.highlight({callback:()=>{e.btn.firstElementChild.classList.remove("active")},getFeature:o=>{let n=o.F.getProperties();delete n.Styles,delete n.geometry,Array.isArray(n.features)&&(n.features=e.features?n.features.map(a=>a.getProperties()[o.layer.cluster.label]):n.features.length),console.log(o.F);let r={id:o.id,layer:o.layer.key,properties:n};e.css??="padding: 1em; max-width: 250px; overflow: auto;";let i=mapp.utils.html.node`<pre
          style=${e.css}
          >${JSON.stringify(r,void 0,2)}`;t.popup({content:i})}}):t.interactions.highlight()}function Et(e,t){let o=t.mapButton;if(!o)return;function n(i){i.target.classList.toggle("active"),document.body.classList.toggle("fullscreen"),t.Map.updateSize(),Object.values(t.layers).forEach(a=>a.mbMap?.resize())}let r=mapp.utils.html.node`
    <button
      data-id="fullscreen"
      class="mobile-display-none"
      title=${mapp.dictionary.toolbar_fullscreen}
      onclick=${n}>
      <span class="notranslate material-symbols-outlined">left_panel_close`;o.append(r)}function $t(e,t){Array.isArray(e)&&t?.locale?.layers.sort((o,n)=>e.indexOf(o.key)-e.indexOf(n.key))}var we;function It(e,t){we=t.mapButton;let o=t.locale.key;we&&e&&(Array.isArray(e)?e.forEach(n=>Lt(n,o)):Lt(e,o))}function Lt(e,t){if(!e?.href){console.warn("You must provide a href for the link_button plugin.");return}e.locale&&(e.href=`${e.href}?locale=${t}`),e.css_class??="";let o=`notranslate material-symbols-outlined ${e.css_class}`;if(!e.icon_name){console.warn("You must provide an icon_name for the link_button plugin. If applicable, remove the mask-icon from the css_class property and/or the svg links from the css_style property.");return}e.icon_name??="open_in_new",e.title??=mapp.dictionary.link;let n=mapp.utils.html.node`
    <a
      title=${e.title}
      href=${e.href}
      target=${e.target}>
      <span
      class=${o}
      style=${e.css_style}>${e.icon_name}`;we.append(n)}function Ot(e,t){let o=t.mapButton;if(!o)return;let n=mapp.utils.html.node`
    <button
      data-id="locator"
      title=${mapp.dictionary.toolbar_current_location}
      onclick=${r=>{r.target.classList.toggle("active"),t.locate()}}><span class="notranslate material-symbols-outlined">my_location`;o.append(n)}function Pt(e,t){let o=t.mapButton;if(!o||!document.head.dataset.login)return;let n=`${mapp.user?"logout":"lock_open"}`,r="notranslate material-symbols-outlined"+(mapp.user?" color-danger":""),i;mapp.user?.sessionIndex?i=`${mapp.host}/saml/logout`:mapp.user?i="?logout=true":i="?login=true",o.appendChild(mapp.utils.html.node`
    <a
      title=${mapp.user?mapp.dictionary.toolbar_logout:mapp.dictionary.toolbar_login}
      href=${i}>
      <span class=${r}>${n}`)}async function Tt(e){return mapp.utils.svgTemplates(e)}async function Ft(e,t){if(mapp.hooks.current.test){e=Object.assign({},e,{quiet:e?.quiet??!1,showSummary:e?.showSummary??!0}),e.options&&(e=e.options,console.warn("please move the options properties into the test plugin object"));try{await mapp.utils.esmImport("codi-test-framework@1.0.37"),globalThis._mappTest||await import(`${mapp.host}/public/js/tests/_mapp.test.js`)}catch(o){console.log(o)}codi&&(mapp.hooks.current.test==="integrity"&&t.Map.once("loadend",async()=>{await codi.runWebTestFunction(()=>_mappTest.integrityTests(t),e)}),mapp.hooks.current.test==="core"&&await codi.runWebTestFunction(()=>_mappTest.coreTest(t),e))}}function At(e,t){e.user=mapp.user||{email:"anonymous"};let o=t.mapButton;o&&(e.title??="userIDB",e.button=mapp.utils.html.node`
  <button
    title=${e.title}
    onclick=${()=>{e.button.classList.toggle("active")?Pn(e):e.dialog?.close()}}>
    <span class="notranslate material-symbols-outlined">rule_settings`,o.append(e.button))}async function Pn(e){let t=mapp.utils.html.node`<div>`,o=await mapp.ui.elements.jsoneditor({props:{content:{text:JSON.stringify(e.user)},mode:"text",onRenderMenu:n},target:t});e.dialog={closeBtn:!0,content:t,header:e.title,onClose:a=>{e.button.classList.remove("active")},target:document.getElementById("Map")},mapp.ui.elements.dialog(e.dialog);function n(a){return a.push({className:"notranslate material-symbols-outlined-important",onClick:r,text:"person_edit",title:"Update User",type:"button"},{className:"notranslate material-symbols-outlined-important",onClick:i,text:"person_remove",title:"Remove User",type:"button"}),a.filter(s=>s.text!=="table").filter(s=>s.text!=="tree").filter(s=>s.type!=="separator").filter(s=>s.className!=="jse-undo").filter(s=>s.className!=="jse-redo").filter(s=>s.className!=="jse-search").filter(s=>s.className!=="jse-contextmenu").filter(s=>s.className!=="jse-sort").filter(s=>s.className!=="jse-transform")}async function r(){let a=o.get(),s=JSON.parse(a.text);await mapp.utils.userIndexedDB.put({store:"user",name:s.email,obj:s})}async function i(){let a=o.get(),s=JSON.parse(a.text);s.email&&(await mapp.utils.userIndexedDB.remove({store:"user",name:s.email}),a.text=JSON.stringify({email:s.email}),o.set(a))}}async function Mt(e,t){if(!mapp.ui?.utils.layerJSE||(e.layersNode=document.getElementById("layers"),!e.layersNode))return;let o=mapp.utils.html.node`<div>`,n={className:"text-button",onClick:()=>Tn(e,t),text:"Add Layer",title:"Add Layer to mapview",type:"button"};e.jsoneditor=await mapp.ui.utils.layerJSE(o,{json:{}},n),e.btn=mapp.utils.html.node`<button
    class="raised"
    onclick=${()=>{e.btn.classList.toggle("active"),e.dialog=mapp.ui.elements.dialog({header:mapp.utils.html.node`<div>`,css_style:"width: 500px; height 300px",containedCentre:!0,contained:!0,closeBtn:!0,onClose:()=>{e.btn.classList.toggle("active")},content:o})}}>Add Layer`,e.layersNode.append(e.btn)}async function Tn(e,t){let o=e.jsoneditor.get(),n=JSON.parse(o.text);n.mapview=t,n.zIndex??=t.zIndex++,n.key??=n.zIndex;let r=await mapp.layer.decorate(n);if(!r.L){console.warn("JSON layer could not be decorated");return}mapp.ui.layers.view(r),e.layersNode.append(r.view),r.mapview.layers[r.key]=r,r.display&&r.show(),e.dialog.close()}function zt(e,t){let o=document.getElementById("layers");o&&(e.content=mapp.ui.elements.userLocale(e,t),o.append(e.content))}function Dt(e,t){if(!t)return;let o=t.mapButton;if(!o)return;let n=o.appendChild(mapp.utils.html.node`
    <button
      data-id="btnZoomIn"
      .disabled=${t.Map.getView().getZoom()>=t.view.maxZoom}
      title=${mapp.dictionary.toolbar_zoom_in}
      onclick=${a=>{let s=parseInt(t.Map.getView().getZoom()+1);t.Map.getView().setZoom(s),a.target.disabled=s>=t.view.maxZoom}}><span class="notranslate material-symbols-outlined">zoom_in`),r=o.appendChild(mapp.utils.html.node`
    <button
      data-id="btnZoomOut"
      .disabled=${t.Map.getView().getZoom()<=t.view.minZoom}
      title=${mapp.dictionary.toolbar_zoom_out}
      onclick=${a=>{let s=parseInt(t.Map.getView().getZoom()-1);t.Map.getView().setZoom(s),a.target.disabled=s<=t.view.minZoom}}><span class="notranslate material-symbols-outlined">zoom_out`);t.changeEndCallbacks.push(i);function i(a){let s=a.Map.getView().getZoom();n.disabled=s>=a.view.maxZoom,r.disabled=s<=a.view.minZoom}}function Nt(e,t){let o=t.mapButton;if(!o)return;function n(i){if(i.target.classList.contains("active")){t.interactions.highlight();return}i.target.classList.add("active"),t.interactions.zoom({callback:()=>{i.target.classList.remove("active"),delete t.interaction,setTimeout(()=>{!t.interaction&&t.interactions.highlight()},400)}})}let r=mapp.utils.html.node`
    <button
      class="mobile-display-none"
      data-id="zoomtoarea"
      title=${mapp.dictionary.toolbar_zoom_to_area}
      onclick=${n}>
      <span class="notranslate material-symbols-outlined">pageview`;o.append(r)}var Fn={admin:kt,custom_theme:jt,dark_mode:St,feature_info:Ct,fullscreen:Et,layer_order:$t,link_button:It,locator:Ot,login:Pt,svg_templates:Tt,test:Ft,userIDB:At,userLayer:Mt,userLocale:zt,zoomBtn:Dt,zoomToArea:Nt},qt=Fn;var Vt={};async function B(e){return Vt[e]??=new Promise(t=>{import(`https://esm.sh/${e}`).then(o=>{t(o)})}),await Vt[e]}var ve=class extends Map{set(t,o){return super.set(t,o),o}},A=class extends WeakMap{set(t,o){return super.set(t,o),o}};var An=/^(?:area|base|br|col|embed|hr|img|input|keygen|link|menuitem|meta|param|source|track|wbr)$/i,Mn=/<([a-z]+[a-z0-9:._-]*)([^>]*?)(\/?)>/g,zn=/([^\s\\>"'=]+)\s*=\s*(['"]?)\x01/g,Dn=/[\x01\x02]/g,Nn=(e,t)=>e.nodeType===111?1/t<0?t?(({firstChild:o,lastChild:n})=>{let r=document.createRange();return r.setStartAfter(o),r.setEndAfter(n),r.deleteContents(),o})(e):e.lastChild:t?e.valueOf():e.firstChild:e,{isArray:qn}=Array,_e=e=>e==null?e:e.valueOf(),Bt=(e,t)=>{let o,n,r=t.slice(2);return!(t in e)&&(n=t.toLowerCase())in e&&(r=n.slice(2)),i=>{let a=qn(i)?i:[i,!1];o!==a[0]&&(o&&e.removeEventListener(r,o,a[1]),(o=a[0])&&e.addEventListener(r,o,a[1]))}},{isArray:Gt,prototype:Vn}=Array,{indexOf:Bn}=Vn,{createDocumentFragment:Rn,createElement:Un,createElementNS:Gn,createTextNode:Zn,createTreeWalker:Kn,importNode:Jn}=new Proxy({},{get:(e,t)=>document[t].bind(document)}),R,Hn=(e,t)=>t?(o=>{R||(R=Gn("http://www.w3.org/2000/svg","svg")),R.innerHTML=o;let n=Rn();return n.append(...R.childNodes),n})(e):(o=>{let n=Un("template");return n.innerHTML=o,n.content})(e),Wn=({childNodes:e},t)=>e[t],T=(e,t,o)=>((n,r,i,a,s)=>{let l=i.length,c=r.length,u=l,f=0,p=0,d=null;for(;f<c||p<u;)if(c===f){let m=u<l?p?a(i[p-1],-0).nextSibling:a(i[u-p],0):s;for(;p<u;)n.insertBefore(a(i[p++],1),m)}else if(u===p)for(;f<c;)d&&d.has(r[f])||n.removeChild(a(r[f],-1)),f++;else if(r[f]===i[p])f++,p++;else if(r[c-1]===i[u-1])c--,u--;else if(r[f]===i[u-1]&&i[p]===r[c-1]){let m=a(r[--c],-1).nextSibling;n.insertBefore(a(i[p++],1),a(r[f++],-1).nextSibling),n.insertBefore(a(i[--u],1),m),r[c]=i[u]}else{if(!d){d=new Map;let m=p;for(;m<u;)d.set(i[m],m++)}if(d.has(r[f])){let m=d.get(r[f]);if(p<m&&m<u){let x=f,h=1;for(;++x<c&&x<u&&d.get(r[x])===m+h;)h++;if(h>m-p){let b=a(r[f],0);for(;p<m;)n.insertBefore(a(i[p++],1),b)}else n.replaceChild(a(i[p++],1),a(r[f++],-1))}else f++}else n.removeChild(a(r[f++],-1))}return i})(e.parentNode,t,o,Nn,e),Yn=(e,t)=>{switch(t[0]){case"?":return((o,n,r)=>i=>{let a=!!_e(i);r!==a&&((r=a)?o.setAttribute(n,""):o.removeAttribute(n))})(e,t.slice(1),!1);case".":return((o,n)=>n==="dataset"?(({dataset:r})=>i=>{for(let a in i){let s=i[a];s==null?delete r[a]:r[a]=s}})(o):r=>{o[n]=r})(e,t.slice(1));case"@":return Bt(e,"on"+t.slice(1));case"o":if(t[1]==="n")return Bt(e,t)}switch(t){case"ref":return(o=>{let n;return r=>{n!==r&&(n=r,typeof r=="function"?r(o):r.current=o)}})(e);case"aria":return(o=>n=>{for(let r in n){let i=r==="role"?r:`aria-${r}`,a=n[r];a==null?o.removeAttribute(i):o.setAttribute(i,a)}})(e)}return((o,n)=>{let r,i=!0,a=document.createAttributeNS(null,n);return s=>{let l=_e(s);r!==l&&((r=l)==null?i||(o.removeAttributeNode(a),i=!0):(a.value=l,i&&(o.setAttributeNodeNS(a),i=!1)))}})(e,t)};function Xn(e){let{type:t,path:o}=e,n=o.reduceRight(Wn,this);return t==="node"?(r=>{let i,a,s=[],l=c=>{switch(typeof c){case"string":case"number":case"boolean":i!==c&&(i=c,a||(a=Zn("")),a.data=c,s=T(r,s,[a]));break;case"object":case"undefined":if(c==null){i!=c&&(i=c,s=T(r,s,[]));break}if(Gt(c)){i=c,c.length===0?s=T(r,s,[]):typeof c[0]=="object"?s=T(r,s,c):l(String(c));break}if(i!==c)if("ELEMENT_NODE"in c)i=c,s=T(r,s,c.nodeType===11?[...c.childNodes]:[c]);else{let u=c.valueOf();u!==c&&l(u)}break;case"function":l(c(r))}};return l})(n):t==="attr"?Yn(n,e.name):(r=>{let i;return a=>{let s=_e(a);i!=s&&(i=s,r.textContent=s??"")}})(n)}var xe=e=>{let t=[],{parentNode:o}=e;for(;o;)t.push(Bn.call(o.childNodes,e)),e=o,{parentNode:o}=e;return t},F="is\xB5",Rt=new A,Qn=/^(?:textarea|script|style|title|plaintext|xmp)$/,er=(e,t)=>{let o=e==="svg",n=((u,f,p)=>{let d=0;return u.join("").trim().replace(Mn,((m,x,h,b)=>{let w=x+h.replace(zn,"=$2$1").trimEnd();return b.length&&(w+=p||An.test(x)?" /":"></"+x),"<"+w+">"})).replace(Dn,(m=>m===""?"<!--"+f+d+++"-->":f+d++))})(t,F,o),r=Hn(n,o),i=Kn(r,129),a=[],s=t.length-1,l=0,c=`${F}${l}`;for(;l<s;){let u=i.nextNode();if(!u)throw`bad template: ${n}`;if(u.nodeType===8)u.data===c&&(a.push({type:"node",path:xe(u)}),c=`${F}${++l}`);else{for(;u.hasAttribute(c);)a.push({type:"attr",path:xe(u),name:u.getAttribute(c)}),u.removeAttribute(c),c=`${F}${++l}`;Qn.test(u.localName)&&u.textContent.trim()===`<!--${c}-->`&&(u.textContent="",a.push({type:"text",path:xe(u)}),c=`${F}${++l}`)}}return{content:r,nodes:a}},tr=(e,t)=>{let{content:o,nodes:n}=Rt.get(t)||Rt.set(t,er(e,t)),r=Jn(o,!0);return{content:r,updates:n.map(Xn,r)}},U=(e,{type:t,template:o,values:n})=>{let r=Zt(e,n),{entry:i}=e;i&&i.template===o&&i.type===t||(e.entry=i=((c,u)=>{let{content:f,updates:p}=tr(c,u);return{type:c,template:u,content:f,updates:p,wire:null}})(t,o));let{content:a,updates:s,wire:l}=i;for(let c=0;c<r;c++)s[c](n[c]);return l||(i.wire=(c=>{let{firstChild:u,lastChild:f}=c;if(u===f)return f||c;let{childNodes:p}=c,d=[...p];return{ELEMENT_NODE:1,nodeType:111,firstChild:u,lastChild:f,valueOf:()=>(p.length!==d.length&&c.append(...d),c)}})(a))},Zt=({stack:e},t)=>{let{length:o}=t;for(let n=0;n<o;n++){let r=t[n];r instanceof E?t[n]=U(e[n]||(e[n]={stack:[],entry:null,wire:null}),r):Gt(r)?Zt(e[n]||(e[n]={stack:[],entry:null,wire:null}),r):e[n]=null}return o<e.length&&e.splice(o),o},E=class{constructor(t,o,n){this.type=t,this.template=o,this.values=n}},Kt=e=>{let t=new A;return Object.assign(((o,...n)=>new E(e,o,n)),{for(o,n){let r=t.get(o)||t.set(o,new ve);return r.get(n)||r.set(n,(i=>(a,...s)=>U(i,{type:e,template:a,values:s}))({stack:[],entry:null,wire:null}))},node:(o,...n)=>U({stack:[],entry:null,wire:null},new E(e,o,n)).valueOf()})},Ut=new A,Jt=(e,t)=>{let o=typeof t=="function"?t():t,n=Ut.get(e)||Ut.set(e,{stack:[],entry:null,wire:null}),r=o instanceof E?U(n,o):o;return r!==n.wire&&(n.wire=r,e.replaceChildren(r.valueOf())),e},Ht=Kt("html"),y=Kt("svg");function ke(...e){return t=>e.reduce((o,n)=>n(o),t)}var Se,Wt;async function or(){Se||(Se=new Promise(e=>{import("https://cdn.skypack.dev/convert@4").then(t=>{Wt=t.convert,e()})})),await Se}var Yt=async(e,t)=>(await or(),e=parseFloat(e),t.units&&t.convertTo&&(e=Wt(e,t.units).to(t.convertTo)),e=e.toFixed(t.decimals||0),e=e.toLocaleString(t.locale||"en-GB"),`${t.prefix||""}${e}${t.suffix||""}`);function je(e){navigator.clipboard.writeText(e)}function Ce(e,t={}){if(!Array.isArray(e)){console.warn("Array argument for csvDownload must be an array");return}t.separator??=",";let o=e.map(i=>(Array.isArray(t.fields)?nr(i,t.fields):Object.values(i)).join(t.separator));t.type??="text/csv;charset=utf-8;",t.join??=`\r
`,t.title??="file",t.header&&Array.isArray(t.fields)&&o.unshift(t.fields.map(i=>i.title||i.field));let n=new Blob([o.join(t.join)],{type:t.type}),r=document.createElement("a");r.download=`${t.title}.csv`,r.href=URL.createObjectURL(n),r.dataset.downloadurl=["csv",r.download,r.href].join(":"),r.style.display="none",document.body.append(r),r.click(),URL.revokeObjectURL(r.href)}function nr(e,t){return t.map(o=>{if(o.field){if(typeof e[o.field]=="string"&&o.string)return`"${e[o.field].replaceAll('"','""')}"`;if(o.formatter==="toLocaleString"){let n=parseFloat(e[o.field]);return isNaN(n)?void 0:`"${n.toLocaleString(o.locale||navigator.language,o.options)}"`}return e[o.field]}})}var rr={int:e=>parseInt(e.replace(/[^\d.-]/g,""))||null,numeric:e=>parseFloat(e.replace(/[^\d.-]/g,""))||null,text:e=>`${e.replace(/'/g,"''")}`,varchar:e=>`${e.replace(/'/g,"''")}`};async function Ee(e,t={}){if(!t.query)return new Error("A query must be supplied for the csv upload.");if(!t.fields)return new Error('Fields are required to define the columns being inserted. Please supply a fields object in the format "fields": {"field_name": "field_type"}".');if(t.query==="sql_table_insert"){if(!t.queryparams.layer)return new Error("A layer must be supplied for the insert query.");if(!t.queryparams.table)return new Error("A table must be supplied for the insert query. Please supply a table in the queryparams object.")}return new Promise(o=>{let n=new FileReader;n.readAsText(e),n.onload=async r=>{let i=r.target.result.trim().split(/\r?\n/),a=i.map(u=>Qt(u).length),s=Math.max(...a);if(s!==Object.keys(t.fields).length){o([new Error(`The number of columns in the CSV file (${s}) does not match the number of fields supplied (${Object.keys(t.fields).length}). Please check your CSV file and try again.`)]);return}t.header&&i.shift();let l=ir(i,t),c=[];if(t.async)c=await Promise.all(l.map(u=>Xt(u,t)));else for(let u of l){let f=await Xt(u,t);c.push(f)}o(c)}})}function ir(e,t){let o=[];t.chunkSize??=4e6;let n=0,r={};return e.forEach(i=>{let a=Qt(i);for(let s in a){let l=Object.keys(t.fields)[s],c=t.fields[l];r[`${l}::${c}`]??=[],r[`${l}::${c}`].push(rr[c](a[s]));let u=new Blob([r]).size;n+u>=t.chunkSize&&(o.push(structuredClone(r)),r={},n=0),n+=u}}),Object.keys(r).length&&o.push(r),o}function Qt(e){let t=[],o="",n=!1;for(let r of e)r==='"'?n=!n:r===","&&!n?(t.push(o.trim()),o=""):o+=r;return o&&t.push(o.trim()),t}function Xt(e,t){t.queryparams??={};let o=mapp.utils.queryParams(t),n=mapp.utils.paramString(o),r=`${mapp.host}/api/query?${n}`;return mapp.utils.xhr({body:JSON.stringify(e),method:"POST",url:r})}function eo(e){if(e.indexOf(";base64,")==-1){let i=e.split(","),a=i[0].split(":")[1],s=i[1];return new Blob([s],{type:a})}let t=e.split(";base64,"),o=t[0].split(":")[1],n=window.atob(t[1]),r=new Uint8Array(n.length);for(let i=0;i<n.length;++i)r[i]=n.charCodeAt(i);return new Blob([r],{type:o})}var $e={};S($e,{datasets:()=>sr,getLocation:()=>lr});function sr(e,t){t.provider||t.qterm&&to(e,t),t.datasets?.forEach(o=>{Object.assign(o,{...t,...o}),to(e,o)})}function to(e,t){let o=t.mapview.layers[t.layer];if(!o){console.warn("No layer definition for gazetteer search.");return}if(!o.table&&!t.table){console.warn("No table definition for gazetteer search.");return}let n=mapp.utils.paramString({filter:o.filter?.current,label:t.label||t.qterm,layer:o.key,limit:t.limit||10,locale:t.mapview.locale.key,qID:o.qID,qterm:t.qterm,table:t.table||o.table,template:t.query||"gaz_query",term:`${t.leading_wildcard?"*":""}${e}*`,wildcard:"*"});t.cache=!0,t.debounce=o.key,t.url=`${t.mapview.host}/api/query?${n}`,mapp.utils.xhr(t).then(r=>{if(t.input.value.length){if(!r){if(t.no_result===null)return;t.list.append(mapp.utils.html.node`
        <li>
          <span class="label">${t.title||o.name}</span>
          <span>${t.no_result||mapp.dictionary.no_results}</span>`);return}[r].flat().forEach(i=>ar(t,o,i))}}).catch(r=>{r instanceof Error&&console.error(r)})}function ar(e,t,o){let n=mapp.utils.html.node`<li
    onclick=${r=>{if(e.callback)return e.callback(o,e);mapp.location.get({id:o.id,layer:t}).then(i=>i?.flyTo?.(e.maxZoom))}}>
    <span class="label">${e.title||t.name}</span>
    <span>${o.label}</span>`;e.list.append(n)}function lr(e,t){if(typeof t.callback=="function"){t.callback(e);return}let o=ol.proj.transform([e.lng,e.lat],"EPSG:4326",`EPSG:${t.mapview.srid}`);if(!ol.extent.containsCoordinate(t.mapview.extent,o)){mapp.ui.elements.alert({text:mapp.dictionary.invalid_lat_lon});return}Object.assign(e,{hook:e.label,Layers:[],Extents:{},layer:{mapview:t.mapview}});let n=[{inline:!0,title:e.label,value:e.source},{class:"display-none",location:e,srid:"4326",type:"pin",value:[e.lng,e.lat],buffer:t.buffer}];mapp.location.decorate(Object.assign(e,{infoj:n})),t.mapview.locations[e.hook]=e,e.flyTo(t.maxZoom)}function oo(e,t={}){navigator.geolocation.getCurrentPosition(e,o=>console.error(o),t)}var no=(e,t)=>isNaN(t)?e:e.length===7?e+(t&&parseInt(t*255).toString(16)||"00"):e.length===4?e+parseInt(t*15).toString(16):e;var io=cr,Le,Ie;function cr(e){if(typeof e!="object")return;let t={};return Le=[],Ie=[],Oe(t,e),Le.forEach(o=>delete o.__parsed),Ie.forEach(o=>delete o.__parsed),t}function Oe(e,t){if(!ro(t))return t;t.__parsed=!0,Le.push(t),Ie.push(e);for(let[o,n]of Object.entries(t))if(!new Set(["__proto__","constructor","mapview"]).has(o)&&!ur(n)&&!pr(e,o,n)){if(Array.isArray(n)){e[o]=n.map(r=>ro(r)?Oe({},r):r);continue}if(n.hasOwnProperty("__parsed")){n.key&&(e[o]=n.key);continue}e[o]??={},Oe(e[o],n)}return e}function ur(e){if(e instanceof Object){let t=Object.getPrototypeOf(e).constructor;if(!(t===Object||t===Array))return!0}if(Array.isArray(e)){let t=e[0];if(t instanceof Object){let o=Object.getPrototypeOf(t).constructor;if(!(o===Object||o===Array)||t.__parsed)return!0}}}function pr(e,t,o){if(t==="__proto__"||t==="constructor"||o===void 0)return!0;if(o===!0)return e[t]=!0,!0;if(o===!1)return e[t]=!1,!0;if(o===null)return e[t]=null,!0;if(typeof o!="object")return e[t]=o,!0}function ro(e){if(e===!0||e===!1||e===null||Array.isArray(e))return!1;if(typeof e=="object")return!0}function so(e){if(!e.keyvalue_dictionary)return;let t=new Map;e.keyvalue_dictionary.forEach(o=>{let n=`${o.key}:${o.value}`;t.set(n,o)}),ao(e,t)}function ao(e,t){for(let[o,n]of Object.entries(e))o!=="mapview"&&(lo(n,t)||typeof n=="string"&&fr(e,o,n,t))}function lo(e,t){if(Array.isArray(e))return e.forEach(o=>lo(o,t)),!0;if(e instanceof Object)return ao(e,t),!0}function fr(e,t,o,n){let r=`${t}:${o}`;if(!n.has(r))return;let i=n.get(r);e[t]=i[mapp?.user?.language||mapp.language]||i.default||o}async function Pe(e){try{let o=await(await fetch(`${mapp.host}/public/dictionaries/${e}.json`)).json();mapp.dictionaries[e]={...mapp.dictionaries[e],...o}}catch(t){console.error(`Failed to fetch language "${e}":`,t)}}function Te(e,t=[".js",".mjs"]){if(Array.isArray(e))return new Promise(o=>{let n=e.filter(r=>t.some(i=>r.endsWith(i))).map(r=>(r.startsWith("http")||(r=`${new URL(document.URL).origin}${r}`),dr(r)));Promise.allSettled(n).then(()=>{o()}).catch(r=>{console.error(r),o()})})}function dr(e){return new Promise((t,o)=>import(e).then(n=>{t(n)}).catch(n=>{console.warn(`Failed to load plugin: ${e}`),console.error(n),o(n)}))}function $(e,...t){if(!t.length)return e;let o=t.shift();if(!Fe(e)||!Fe(o))return $(e,...t);for(let n in o)Object.getPrototypeOf(o)===Object.getPrototypeOf({})&&(n==="__proto__"||n==="constructor"||(o[n]instanceof HTMLElement?console.warn(o[n]):Fe(o[n])?(e[n]??={},$(e[n],o[n])):e[n]=o[n]));return $(e,...t)}function Fe(e){if(e===!0||e===!1||e===null||Array.isArray(e))return!1;if(typeof e=="object")return!0}var co=0;function Ae(e){if(!e)return window.innerWidth<=co;co=e}function uo(e){e.prefix??="",e.suffix??="";let t=e.newValue!==void 0?parseFloat(e.newValue):parseFloat(e.value);return e.localeString="",e.formatterParams===void 0&&(e.formatterParams={locale:mapp.language}),e.formatterParams===null&&!isNaN(t)?e.localeString=t.toString():isNaN(t)||(e.formatterParams.locale??=navigator.language||mapp.language,e.formatterParams.options??={},e.formatterParams.options.maximumFractionDigits??=e.round||(e.type==="integer"?0:2),e.localeString=new Intl.NumberFormat(e.formatterParams.locale,e.formatterParams.options).format(t)),e.lastCharacter||="",e.stringValue=`${e.prefix}${e.localeString}${e.lastCharacter}${e.suffix}`,e.stringValue}function po(e){if(!e.stringValue)return null;let t=e.stringValue;if(e.prefix&&(t=t.replace(e.prefix,"")),e.suffix&&(t=t.replace(e.suffix,"")),t.length&&e.formatterParams?.locale){let n=new Intl.NumberFormat(e.formatterParams.locale).formatToParts(10000.1),r=n.find(l=>l.type==="decimal")?.value,i=n.find(l=>l.type==="group")?.value,a=t.replaceAll(i,"");a=a.replace(r,".");let s=a.replace(/[^\d.-]/g,"");return delete e.lastCharacter,t.endsWith(r)&&(e.lastCharacter=r),t.endsWith(r+0)&&(e.lastCharacter=r+0),t=parseFloat(s),t}return t===""?null:parseFloat(t)}function Me(e,t){if(!e)return null;let o=[];return e=Array.isArray(e)?e:[e],e.forEach(n=>{if(n.icon&&(Array.isArray(n.icon)?n.icon.forEach(r=>fo(o,n,r,t)):fo(o,n,n.icon,t)),n.fillColor||n.strokeColor){let r=n.fillColor&&new ol.style.Fill({color:mapp.utils.hexa(n.fillColor,n.fillOpacity)}),i=n.strokeColor&&new ol.style.Stroke({color:mapp.utils.hexa(n.strokeColor,n.strokeOpacity),width:parseFloat(n.strokeWidth||1),lineDash:n.lineDash});o.push(new ol.style.Style({fill:r,stroke:i,zIndex:n.zIndex}))}if(typeof n.label?.text<"u"){let r=new ol.style.Text({fill:new ol.style.Fill({color:n.label.fillColor||"#000"}),font:n.label.font||"12px sans-serif",offsetX:n.label.offsetX,offsetY:n.label.offsetY,overflow:n.label.overflow,stroke:n.label.strokeColor&&new ol.style.Stroke({color:n.label.strokeColor,width:n.label.strokeWidth||1}),text:String(n.label.text)});o.push(new ol.style.Style({text:r,zIndex:n.zIndex}))}}),t?.set?.("Styles",o,!0),o}function fo(e,t,o,n){let r=o.scale||1;r*=t.scale||1,r*=t.clusterScale||1,r*=t.fieldScale||1,r*=t.zoomInScale||1,r*=t.zoomOutScale||1,r*=t.highlightScale||1,o.url??=o.svg||mapp.utils.svgSymbols[o.type||"dot"](o,n),o.url&&e.push(new ol.style.Style({image:new ol.style.Icon({anchor:o.anchor||[.5,.5],crossOrigin:"anonymous",scale:r,src:o.url}),zIndex:t.zIndex}))}var mo=mr;function mr(e){return e?Object.entries(e).filter(o=>o[1]===0||!!o[1]).filter(o=>o[1]!=="{}").filter(o=>typeof o[1]!="object"||o[1].length||Object.values(o[1]).some(n=>typeof n=="object"&&Object.keys(n).length)).map(o=>typeof o[1]=="object"&&!Array.isArray(o[1])?`${o[0]}=${encodeURIComponent(JSON.stringify(o[1]))}`:`${o[0]}=${encodeURIComponent(o[1])}`).join("&"):""}function ze(e){if(!e.query){console.warn("A query parameter must be defined for the ping utility.");return}e.interval??=4e3,e.host??=mapp.host;let t=mapp.utils.queryParams(e),o=mapp.utils.paramString(t);return e.url=`${mapp.host}/api/query?${o}`,hr(e)}function hr(e){return new Promise((t,o)=>{let n=async()=>{let r=await mapp.utils.xhr(e);if(r instanceof Error)return o(r);if(e.callback instanceof Function&&e.callback(r,e),e.callback===!1||e.failCondition===r||e.successCondition===r)return t(r);setTimeout(n,e.interval)};n()})}function ho(e){if(!e.mapview)return;function t(n){return Array.isArray(n)?1+Math.max(0,...n.map(t)):0}let o={drawend:n=>{let i=n.feature.getGeometry(),a=e.mapview.interaction.snap.source.getFeatures();a=a.filter(s=>{let l=s.getGeometry().getCoordinates();return l=l.flat(t(l)-2),l.some(c=>i.intersectsCoordinate(c))}),e.drawendCallback&&e.drawendCallback(a)},type:"Polygon",...e};e.mapview.interactions.draw(o)}var go={addProjection:gr};async function gr(e){let t=await mapp.utils.esmImport("proj4@2.9.0");t.default.defs(e.name,e.defs);let o=new ol.proj.Projection({code:e.name,extent:e.extent});ol.proj.addProjection(o),ol.proj.addCoordinateTransforms("EPSG:3857",e.name,n=>t.default("EPSG:3857",e.name,n),n=>t.default(e.name,"EPSG:3857",n))}var yo=e=>new Promise((t,o)=>{Promise.all(e).then(t).catch(n=>{console.error(n),o(n)})});var bo=yr;function yr(e){if(e.queryparams??={},typeof e.queryparams!="object"){console.warn("queryparams must be an object");return}let t=e.layer||e.location?.layer;t?.queryparams&&(e.queryparams={...t.queryparams,...e.queryparams}),e.queryparams.table&&=typeof e.queryparams.table=="string"?e.queryparams.table:br(e);let o=e.viewport&&e.layer.mapview.getBounds(),n=typeof e.queryparams.geom=="string"?e.queryparams.geom:wr(e),r=e.queryparams.center&&ol.proj.transform(e.layer.mapview.Map.getView().getCenter(),`EPSG:${e.layer.mapview.srid}`,"EPSG:4326"),i=e.queryparams.template||encodeURIComponent(e.query),a=e.queryparams.filter?t?.filter?.current:void 0,s=t?.mapview?.locale.key||e.location?.locale||void 0,l=e.queryparams.id?e.location?.id:void 0,c=e.queryparams.qID?e.location?.layer?.qID:void 0,u=e.queryparams.email?mapp.user.email:void 0,f=r?.[1],p=r?.[0],d=e.queryparams?.z&&t.mapview.Map.getView().getZoom(),m=o&&[o.west,o.south,o.east,o.north,t.mapview.srid];return t=t?.key||e.queryparams.layer||void 0,{...e.queryparams,email:u,fieldValues:void 0,filter:a,geom:n,id:l,lat:f,layer:t,lng:p,locale:s,qID:c,template:i,viewport:m,z:d}}function br(e){return e.location?.layer?.table||e.layer?.table||e.location?.layer?.tableCurrent?.()||e.layer?.tableCurrent?.()||e.location?.layer?.tableCurrent?.()||e.layer?.tables&&Object.values(e.layer.tables).find(t=>!!t)||e.location?.layer?.tables&&Object.values(e.location?.layer.tables).find(t=>!!t)}function wr(e){return e.viewport?e.layer.geomCurrent():void 0}var wo={};async function De(e,t="module"){return wo[e]??=new Promise((o,n)=>{let r=document.createElement("script");r.type=t,r.src=e,r.addEventListener("load",()=>{console.log(`${r.src} script loaded.`),o()}),r.addEventListener("error",n),document.head.append(r)}),await wo[e]}var qe={};S(qe,{circle:()=>$r,diamond:()=>Sr,dot:()=>xr,markerColor:()=>Er,markerLetter:()=>Cr,semiCircle:()=>jr,square:()=>kr,target:()=>vr,template:()=>Lr,triangle:()=>_r});var k=new XMLSerializer,Ne={dot:new Map};function xr(e){let t=Object.values({fillColor:e.fillColor}).reduce((n,r)=>n+r);if(Ne.dot.has(t))return Ne.dot.get(t);let o=y.node`
    <svg width=24 height=24 viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
      <circle cx=13 cy=13 r=10 fill='#333'></circle>
      <circle cx=12 cy=12 r=10 fill=${e.fillColor||"#fff"}></circle>`;return o=`data:image/svg+xml,${encodeURIComponent(k.serializeToString(o))}`,Ne.dot.set(t,o),o}function vr(e){let t=y.node`
    <svg width=24 height=24 viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
      <circle cx=13 cy=13 fill='#333' r=10 opacity=0.4></circle>
      <circle cx=12 cy=12 r=10 fill=${e.fillColor||"#FFF"}>`;return e.layers&&Object.entries(e.layers).forEach(o=>{t.appendChild(y.node`<circle cx=12 cy=12 r=${parseFloat(o[0])*10} fill=${o[1]}>`)}),`data:image/svg+xml,${encodeURIComponent(k.serializeToString(t))}`}function _r(e){let t=y.node`
    <svg width=24 height=24 viewBox='${"0 0 24 24"}' xmlns='http://www.w3.org/2000/svg'>
      <polygon
        points="12,4.68 2,22 22,22"
        fill="#333" stroke="#333" opacity=0.4 stroke-opacity=0.4 stroke-width=3
        stroke-linejoin="round"/>`;return t.appendChild(y.node`
    <polygon
      fill=${e.fillColor||"#FFF"} stroke=${e.fillColor||"#FFF"} stroke-width=2
      points="12,4.68 2,22 22,22"  stroke-linejoin="round"/>`),e.layers&&Object.entries(e.layers).forEach(o=>{function n(a,s){return 12+(a-12)*s}function r(a,s){return 16+(a-16)*s}let i=`${n(12,o[0])},${r(4.68,o[0])} ${n(2,o[0])}, ${r(22,o[0])} ${n(22,o[0])}, ${r(22,o[0])}`;t.appendChild(y.node`
      <polygon
        points="${i}"
        fill=${o[1]}
        stroke=${o[1]||"#FFF"}
        stroke-width=1
        stroke-linejoin="round"/>`)}),`data:image/svg+xml,${encodeURIComponent(k.serializeToString(t))}`}function kr(e){let t=y.node`
    <svg width=24 height=24 viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
      <rect fill='#333' opacity=0.3 width=20 height=20 x=2 y=2 rx=1></rect>
      <rect fill=${e.fillColor||"#FFF"} width=20 height=20 x=0 y=0 rx=1></rect>`;return e.layers&&Object.entries(e.layers).forEach(o=>{t.appendChild(y.node`
      <rect fill=${o[1]}
        width=${parseFloat(o[0])*20}
        height=${parseFloat(o[0])*20}
        x=${10*(1-parseFloat(o[0]))}
        y=${10*(1-parseFloat(o[0]))} rx=${parseFloat(o[0])}></rect>`)}),`data:image/svg+xml,${encodeURIComponent(k.serializeToString(t))}`}function Sr(e){let t=y.node`
    <svg width=24 height=24 viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
      <polygon
        fill='#333'
        opacity=0.3
        points="12 0, 24 12, 12 24, 0 12"></polygon>
      <polygon
        fill=${e.fillColor||"#FFF"}
        points="12 0, 24 12, 12 24, 0 12"></polygon>`;function o(n,r){return 12+(n-12)*r}return e.layers&&Object.entries(e.layers).forEach(n=>{let r=`${o(12,n[0])} ${o(0,n[0])},${o(24,n[0])} ${o(12,n[0])},${o(12,n[0])} ${o(24,n[0])}, ${o(0,n[0])} ${o(12,n[0])}`;t.appendChild(y.node`
      <polygon
        fill=${n[1]||"#FFF"}
        points="${r}"></polygon>`)}),`data:image/svg+xml,${encodeURIComponent(k.serializeToString(t))}`}function jr(e){let t=y.node`
    <svg width=30 height=30 viewBox='0 0 20 24' xmlns='http://www.w3.org/2000/svg'>
      <defs>
        <clipPath id="cut-off-shade">
          <rect x="0" y="0" width="24" height="11"/>
        </clipPath>
        <clipPath id="cut-off">
          <rect x="0" y="0" width="24" height="10"/>
        </clipPath>
      </defs>
      <circle cx="11" cy="10" r="10" clip-path="url(#cut-off-shade)" fill="#333" opacity=0.4></circle>
      <circle cx=10 cy=10 r=10 fill=${e.fillColor||"#FFF"} clip-path="url(#cut-off-shade)">`;return e.layers&&Object.entries(e.layers).forEach(o=>{t.appendChild(y.node`
      <circle cx=10 cy=10 r=${parseFloat(o[0])*10} fill=${o[1]} clip-path="url(#cut-off-shade)">`)}),`data:image/svg+xml,${encodeURIComponent(k.serializeToString(t))}`}function Cr(e){let t=y.node`
    <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path fill="${e.color}"
        d="M 12 1.969 C 7.878 1.969 4.813 5.239 4.813 9.328 C 4.813 10.554 5.222 12.189 6.244 14.028 C 8.289 17.504 12 22 12 22 C 12 22 16.055 17.504 18.099 14.028 C 19.122 12.189 19.341 10.963 19.341 9.328 C 19.341 5.239 16.054 1.969 12 1.969 Z"/>
      <circle cx="12.17192400568182" cy="8.918683238636365" r="5.109789772727275" fill="rgb(255, 255, 255)"/>
      <text x="12" y="12" style="text-anchor: middle; font-weight: 600; font-size: 9px; font-family: sans-serif; fill: rgb(85, 85, 85);">
      ${e.letter}`;return`data:image/svg+xml,${encodeURIComponent(k.serializeToString(t))}`}function Er(e){let t=y.node`
    <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path style="opacity: 0.5;" fill="${e.colorMarker}"
        d="M 10.797 1.238 C 6.308 1.238 2.716 4.83 2.716 9.32 C 2.716 11.116 3.165 12.463 4.287 14.483 C 6.532 18.3 9.952 23.234 9.952 23.234 C 9.952 23.234 15.063 18.3 17.308 14.483 C 18.43 12.463 18.879 11.116 18.879 9.32 C 18.879 4.83 15.287 1.238 10.797 1.238 Z"/>
      <path fill="${e.colorMarker}"
        d="M 10 1.238 C 5.51 1.238 2.144 4.83 2.144 9.32 C 2.144 10.667 2.593 12.463 3.716 14.483 C 5.961 18.3 10 23.238 10 23.238 C 10 23.238 14.491 18.3 16.736 14.483 C 17.859 12.463 18.1 11.116 18.1 9.32 C 18.1 4.83 14.49 1.238 10 1.238 Z"/>
      <circle cx="10.226" cy="8.871" r="5.612" opacity="0.8" fill="rgb(255, 255, 255)"/>
      <circle cx="10.226" cy="8.871" r="2.806" opacity="0.8" fill="${e.colorDot}"/>`;return`data:image/svg+xml,${encodeURIComponent(k.serializeToString(t))}`}function $r(e){let t=y.node`
    <svg width=24 height=24 viewBox='0 0 30 30' xmlns='http://www.w3.org/2000/svg'>
      <circle cx=16 cy=16 r=10
        stroke="${e.strokeColor||"#333"}"
        stroke-width="${e.strokeWidth||1}"
        fill="#ffffff33">`;return`data:image/svg+xml,${encodeURIComponent(k.serializeToString(t))}`}function Lr(e){let t=mapp.utils.svgSymbols.templates?.[e.template];if(t)return typeof e.substitute=="object"&&Object.entries(e.substitute).forEach(o=>{t=t.replaceAll(o[0],o[1])}),`data:image/svg+xml,${encodeURIComponent(t)}`}async function Ve(e){if(!e||!Object.keys(e).length)return;mapp.utils.svgSymbols.templates??={};let t=Object.keys(e).filter(o=>!Object.hasOwn(mapp.utils.svgSymbols.templates,o)).map(o=>fetch(e[o]).then(n=>n.text()).then(n=>{mapp.utils.svgSymbols.templates[o]=n}));await Promise.all(t)}var Ir="en-GB";function Be(e){if(!Number.isInteger(e)){console.error("unixTimestamp must be integer for Date conversion");return}return new Date(e*1e3)}function Or(e){e.locale??=navigator.language||Ir;let t=parseInt(e.newValue||e.value),o=Be(t);return new Intl.DateTimeFormat(e.locale,e.options).format(o)}function Pr(e){let t=e?new Date(e):new Date;if(isNaN(t.getTime())){console.error("Invalid date string provided");return}return Math.floor(t.getTime()/1e3)}function Tr(e){return e?Be(e).toISOString().split(".")[0]:void 0}function Fr(e){return e?Be(e).toISOString().split("T")[0]:void 0}var xo={date:Fr,dateString:Or,dateToUnixEpoch:Pr,datetime:Tr};function Re(e){if(typeof e.text!="string")return;e.filename??="file.txt",e.type??="text";let t=new Blob([e.text],{type:e.type}),o=URL.createObjectURL(t),n=document.createElement("a");n.href=o,n.download=`${e.filename}`,n.click(),URL.revokeObjectURL(o)}var Ue={};S(Ue,{add:()=>Ar,get:()=>Mr,list:()=>zr,openDB:()=>L,put:()=>Dr,remove:()=>Nr});async function L(e){return await new Promise((n,r)=>{e.indexedDB??="MAPP";let i=indexedDB.open(e.indexedDB,3);i.onerror=a=>{console.error(i.error),n(i)},i.onsuccess=a=>{a.target.result.objectStoreNames.contains(e.store)||(console.warn(`UserIDB '${e.indexedDB}' doesn't contain "${e.store}" objectStore.`),n(null)),n(a.target.result)},i.onupgradeneeded=a=>{a.target.result.createObjectStore(e.store)}})}async function Ar(e){let t=await L(e),o=new Promise((n,r)=>{let s=t.transaction([e.store],"readwrite").objectStore(e.store).add(e.obj);s.onerror=l=>{console.error(s.error),r(s.error)},s.onsuccess=l=>{n(l.target.result)}});return await o,o}async function Mr(e){let t=await L(e),o=new Promise((n,r)=>{let s=t.transaction([e.store],"readwrite").objectStore(e.store).get(e.name);s.onerror=l=>{console.error(s.error),r(s.error)},s.onsuccess=l=>{n(s.result)}});return await o,o}async function zr(e){let t=await L(e),o=new Promise((n,r)=>{let s=t.transaction([e.store],"readwrite").objectStore(e.store).getAll();s.onerror=l=>{console.error(s.error),r(s)},s.onsuccess=l=>{let c=s.result.map(u=>({key:u.key,name:u.name}));n(c)}});return await o,o}async function Dr(e){let t=await L(e),o=new Promise((n,r)=>{let s=t.transaction([e.store],"readwrite").objectStore(e.store).put(e.obj,e.name);s.onerror=l=>{console.error(s.error),r(s)},s.onsuccess=l=>{n(s.result)}});return await o,o}async function Nr(e){let t=await L(e),o=new Promise((n,r)=>{let s=t.transaction([e.store],"readwrite").objectStore(e.store).delete(e.name);s.onerror=l=>{console.error(s.error),r(s)},s.onsuccess=l=>{n()}});return await o,o}var Ge={};S(Ge,{get:()=>qr,list:()=>Br,putLocale:()=>Vr,remove:()=>Rr});async function qr(e){return await mapp.utils.userIndexedDB.get({indexedDB:e.workspace,store:"locales",user:mapp.user.email||"anonymous",name:e.name})}async function Vr(e,t){let o=mapp.utils.jsonParser(e.locale);return o.layers=Object.values(e.layers).map(mapp.utils.jsonParser),await mapp.utils.userIndexedDB.put({indexedDB:o.workspace,store:"locales",user:mapp.user.email||"anonymous",name:o.name,obj:o})}async function Br(e){return await mapp.utils.userIndexedDB.list({indexedDB:e,store:"locales",user:mapp.user.email||"anonymous"})}async function Rr(e){return await mapp.utils.userIndexedDB.remove({indexedDB:e.workspace,store:"locales",user:mapp.user.email||"anonymous",name:e.name})}function vo(e){let t=parseInt(mapp.version.split(".")[0]),o=parseInt(mapp.version.split(".")[1]),n=parseInt(mapp.version.split(".")[2]),r=parseInt(e.toString().split(".")[0]),i=parseInt(e.toString().split(".")[1]),a=parseInt(e.toString().split(".")[2])||0;return t>r?!0:t===r?o>i?!0:o===i&&n>=a:!1}var _o=e=>{let t=e.getGeometry();if(t.getType()==="Point")return new ol.geom.Point(t.getCoordinates());let o=t.getCoordinates(),n=ko(o);return n===2?new ol.geom.MultiPoint(o):(o=n>3?o.flat(2):o[0],new ol.geom.MultiPoint(o))};function ko(e){return Array.isArray(e)?1+Math.max(0,...e.map(ko)):0}var Ze=new Map;function So(e){return new Promise((t,o)=>{if(!e)return console.error("xhr params are falsy."),o(new Error("xhr params are required"));if(e=typeof e=="string"?{url:e}:{...e},!e.url)return console.error("no xhr request url has been provided."),o(new Error("no xhr request url has been provided."));e.method??=e.body?"POST":"GET",e.responseType??="json";let n=new XMLHttpRequest;if(n.open(e.method,e.url,!0),e.requestHeader!==null){let r={"Content-Type":"application/json",...e.requestHeader};Object.entries(r).forEach(([i,a])=>n.setRequestHeader(i,a))}if(n.responseType=e.responseType,e.cache&&Ze.has(e.url)){let r=Ze.get(e.url);return t(e.resolveTarget?r:r.response)}if(n.onload=()=>{if(n.status>=400)return o(new Error(`HTTP ${n.status}`));let r=e.resolveTarget?n:n.response;e.cache&&Ze.set(e.url,e.resolveTarget?n:{response:r}),t(r)},!Ur(n,e,o))try{n.send(e.body)}catch(r){return r}})}var Ke=new Map;function Ur(e,t,o){if(!t.debounce)return;typeof t.debounce=="number"&&(t.delay=t.debounce),t.delay??=300,typeof t.debounce=="string"&&(t.key??=t.debounce),t.key??="global";let n=Ke.get(t.key);n&&(clearTimeout(n.timeoutId),n.reject("Request Debounced"));let r=setTimeout(()=>{Ke.delete(t.key),e.send(t.body)},t.delay);return Ke.set(t.key,{timeoutId:r,reject:o}),!0}async function Gr(){return await B("simple-statistics@7.8.8")}async function Zr(){await mapp.utils.scriptElement("https://cdn.jsdelivr.net/npm/ol@v10.7.0/dist/ol.js","application/javascript")}var Kr=(e,t)=>e.size===t.size&&[...e].every(o=>t.has(o)),jo={areSetsEqual:Kr,compose:ke,convert:Yt,copyToClipboard:je,csvDownload:Ce,csvUpload:Ee,dataURLtoBlob:eo,esmImport:B,formatNumericValue:uo,gazetteer:$e,getCurrentPosition:oo,hexa:no,html:Ht,jsonParser:io,keyvalue_dictionary:so,loadDictionary:Pe,loadPlugins:Te,merge:$,mobile:Ae,olScript:Zr,paramString:mo,ping:ze,polygonIntersectFeatures:ho,proj4:go,promiseAll:yo,queryParams:bo,render:Jt,scriptElement:De,simpleStatistics:Gr,style:Me,svg:y,svgSymbols:qe,svgTemplates:Ve,temporal:xo,textFile:Re,unformatStringValue:po,userIndexedDB:Ue,userLocale:Ge,versionCheck:vo,verticeGeoms:_o,xhr:So};M.parse();var Co=10.7;globalThis.ol??={};ol.util?.VERSION?Number.parseFloat(ol.util?.VERSION)<Co?console.warn(`Openlayers v${ol.util?.VERSION} below current v${Co}.`):console.log(`Openlayers v${ol.util?.VERSION}`):console.warn("Openlayers has not been loaded.");globalThis.mapp={dictionaries:Ye,dictionary:We,hash:"c3aa678427f05755ce358258c632b66e540c09a0",hooks:M,host:document.head?.dataset?.dir||"",language:M.current.language||"en",layer:ut,location:ft,Mapview:be,plugins:qt,utils:jo,version:"4.21.0"};
/*! (c) Andrea Giammarchi - ISC */
//# sourceMappingURL=mapp.js.map
